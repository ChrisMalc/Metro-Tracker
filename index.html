<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Metro">
  <meta name="theme-color" content="#1e3a8a">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAADsklEQVR4nO3SwW0dQAxDQVeSQlyim04q8G0V8hMjYM4SoPf15/vnL6z4Sh8ALwmaKYJmiqCZImimCJopgmaKoJkiaKYImimCZoqgmSJopgiaKYJmiqCZImimCJopgmaKoJkiaKYImimCZoqgmSJopgiaKYJmiqCZImimCJopgmaKoJkiaKYImimCZoqgmSJopgiaKYJmiqCZImimCJopgmaKoJkiaKYImimCZoqgmSJopgiaKYJmiqCZImimCJopHxm0+T+T/rOgzdNJ/1nQ5umk/yxo83TSfxa0eTrpPwvaPJ30nwVtnk76z4I2Tyf9Z0Gbp5P+s6DN00n/WdDm6aT/LGjzdNJ/FrR5Ouk/C9o8nfSfBW2eTvrPgjZPJ/1nQZunk/6zoM3TSf9Z0ObppP8saPN00n8WdMnjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jYR9MHjUvel9jb5yKDhN4JmiqCZImimCJopgmaKoJkiaKYImimCZoqgmSJopgiaKYJmiqCZImimCJopgmaKoJkiaKYImimCZoqgmSJopgiaKYJmiqCZImimCJopgmaKoJkiaKYImimCZoqgmSJopgiaKYJmiqCZImimCJopgmaKoJkiaKYImimCZoqgmSJopgiaKYJmyj/pQs7OOPUmvQAAAABJRU5ErkJggg==">
  <title>DC Metro Tracker</title>
  <style>
    :root {
      --red: #ef4444;
      --blue: #3b82f6;
      --yellow: #eab308;
      --orange: #f97316;
      --green: #22c55e;
      --silver: #9ca3af;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      overscroll-behavior-y: contain;
      background: #0f172a;
    }

    .app {
      min-height: 100vh;
      min-height: 100dvh;
      background: linear-gradient(160deg, #1e3a8a 0%, #1e40af 40%, #3730a3 100%);
      padding: calc(1rem + var(--safe-top)) 1rem calc(2rem + var(--safe-bottom)) 1rem;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 0.625rem;
    }

    .header-icon {
      width: 28px;
      height: 28px;
      color: white;
      opacity: 0.9;
    }

    .header-title {
      font-size: 1.375rem;
      font-weight: 700;
      color: white;
      letter-spacing: -0.02em;
    }

    .header-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .icon-btn {
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: white;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    .icon-btn:active {
      transform: scale(0.92);
      background: rgba(255, 255, 255, 0.25);
    }

    .icon-btn:disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    .icon-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Status bar */
    .status-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: rgba(255, 255, 255, 0.6);
      font-size: 0.8125rem;
      margin-bottom: 1rem;
    }

    .status-bar svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    /* Error alert */
    .alert {
      background: rgba(239, 68, 68, 0.15);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 0.875rem 1rem;
      margin-bottom: 1rem;
      display: flex;
      gap: 0.625rem;
    }

    .alert svg {
      width: 18px;
      height: 18px;
      color: #fca5a5;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .alert-title {
      color: #fecaca;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .alert-text {
      color: #fca5a5;
      font-size: 0.8125rem;
      margin-top: 0.125rem;
    }

    /* Station cards */
    .station-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 14px;
      margin-bottom: 0.75rem;
      overflow: hidden;
      transition: background 0.2s;
    }

    .station-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.875rem 1rem;
      cursor: pointer;
      -webkit-user-select: none;
      user-select: none;
    }

    .station-header:active {
      background: rgba(255, 255, 255, 0.05);
    }

    .station-header-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      min-width: 0;
    }

    .collapse-arrow {
      width: 16px;
      height: 16px;
      color: rgba(255, 255, 255, 0.5);
      transition: transform 0.25s ease;
      flex-shrink: 0;
    }

    .collapse-arrow.expanded {
      transform: rotate(90deg);
    }

    .station-name {
      font-size: 1rem;
      font-weight: 600;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .station-badge {
      font-size: 0.6875rem;
      color: rgba(255, 255, 255, 0.45);
      font-weight: 500;
      flex-shrink: 0;
      padding-left: 0.5rem;
    }

    .station-trains {
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.25s ease;
    }

    .station-trains.collapsed {
      max-height: 0 !important;
      opacity: 0;
    }

    .station-trains.expanded {
      opacity: 1;
    }

    .trains-inner {
      padding: 0 0.75rem 0.75rem 0.75rem;
    }

    .train-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.625rem 0.75rem;
      background: rgba(255, 255, 255, 0.06);
      border-radius: 10px;
      margin-bottom: 0.375rem;
    }

    .train-item:last-child {
      margin-bottom: 0;
    }

    .train-left {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      flex: 1;
      min-width: 0;
    }

    .line-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .train-info {
      flex: 1;
      min-width: 0;
    }

    .train-dest {
      color: white;
      font-weight: 500;
      font-size: 0.9375rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .train-meta {
      color: rgba(255, 255, 255, 0.45);
      font-size: 0.6875rem;
      margin-top: 0.0625rem;
    }

    .train-time {
      color: white;
      font-weight: 700;
      font-size: 1.0625rem;
      text-align: right;
      flex-shrink: 0;
      padding-left: 0.75rem;
    }

    .train-time.arriving {
      color: #4ade80;
    }

    .no-trains {
      color: rgba(255, 255, 255, 0.4);
      text-align: center;
      padding: 1rem 0;
      font-size: 0.875rem;
    }

    /* Empty state */
    .empty-state {
      background: rgba(255, 255, 255, 0.06);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 14px;
      padding: 3rem 1.5rem;
      text-align: center;
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      color: rgba(255, 255, 255, 0.25);
      margin-bottom: 1rem;
    }

    .empty-title {
      color: white;
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.375rem;
    }

    .empty-subtitle {
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.875rem;
      margin-bottom: 1.25rem;
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.625rem 1.25rem;
      background: white;
      color: #1e3a8a;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9375rem;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .btn-primary:active {
      transform: scale(0.95);
    }

    /* Settings panel */
    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 100;
      opacity: 0;
      transition: opacity 0.25s ease;
      pointer-events: none;
    }

    .settings-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .settings-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      max-width: 420px;
      background: #f8fafc;
      z-index: 101;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .settings-panel.visible {
      transform: translateX(0);
    }

    .settings-inner {
      padding: calc(1rem + var(--safe-top)) 1.25rem calc(2rem + var(--safe-bottom)) 1.25rem;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }

    .settings-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: #0f172a;
    }

    .btn-done {
      color: #2563eb;
      font-weight: 600;
      font-size: 1rem;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.25rem 0;
    }

    .btn-done:active {
      opacity: 0.7;
    }

    /* Search input */
    .search-group {
      margin-bottom: 1.25rem;
    }

    .search-label {
      display: block;
      font-size: 0.8125rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: white;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      color: #0f172a;
      transition: border-color 0.2s;
      font-family: inherit;
    }

    .search-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12);
    }

    .search-input::placeholder {
      color: #94a3b8;
    }

    /* Search results */
    .search-results {
      max-height: 240px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 1.5rem;
    }

    .search-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: 0.75rem 0.875rem;
      text-align: left;
      background: white;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      cursor: pointer;
      margin-bottom: 0.375rem;
      transition: background 0.15s;
      font-family: inherit;
    }

    .search-item:active:not(:disabled) {
      background: #eff6ff;
    }

    .search-item:disabled {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    .search-item-name {
      font-weight: 500;
      color: #0f172a;
      font-size: 0.9375rem;
    }

    .search-item:disabled .search-item-name {
      color: #94a3b8;
    }

    .search-item-badge {
      font-size: 0.6875rem;
      color: #94a3b8;
      font-weight: 500;
    }

    .search-item:disabled .search-item-badge {
      color: #cbd5e1;
    }

    /* Station list in settings */
    .section-label {
      font-size: 0.8125rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.625rem;
    }

    .station-list-item {
      background: white;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      padding: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .station-list-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .station-list-name {
      font-weight: 600;
      color: #0f172a;
      font-size: 0.9375rem;
    }

    .btn-remove {
      color: #ef4444;
      font-size: 0.8125rem;
      font-weight: 600;
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.25rem 0;
    }

    .btn-remove:active {
      opacity: 0.7;
    }

    /* Line filter toggles */
    .line-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.375rem;
      margin-top: 0.625rem;
      padding-top: 0.625rem;
      border-top: 1px solid #f1f5f9;
    }

    .line-filter-label {
      font-size: 0.6875rem;
      font-weight: 600;
      color: #94a3b8;
      width: 100%;
      margin-bottom: 0.125rem;
    }

    .line-toggle {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.3125rem 0.625rem;
      border-radius: 8px;
      border: 1.5px solid #e2e8f0;
      background: white;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }

    .line-toggle.active {
      border-color: currentColor;
      background: currentColor;
    }

    .line-toggle-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .line-toggle.active .line-toggle-dot {
      background: white !important;
    }

    .line-toggle-text {
      font-size: 0.75rem;
      font-weight: 600;
      color: #475569;
    }

    .line-toggle.active .line-toggle-text {
      color: white;
    }

    /* Pair suggestion banner */
    .pair-banner {
      background: #eff6ff;
      border: 1.5px solid #bfdbfe;
      border-radius: 10px;
      padding: 0.875rem;
      margin-bottom: 1.25rem;
      display: flex;
      gap: 0.625rem;
    }

    .pair-banner svg {
      width: 18px;
      height: 18px;
      color: #3b82f6;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .pair-content {
      flex: 1;
    }

    .pair-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #1e3a8a;
    }

    .pair-text {
      font-size: 0.8125rem;
      color: #3b82f6;
      margin-top: 0.125rem;
    }

    .pair-buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.625rem;
    }

    .btn-pair-add {
      padding: 0.4375rem 0.875rem;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-pair-add:active {
      background: #1d4ed8;
    }

    .btn-pair-skip {
      padding: 0.4375rem 0.875rem;
      background: white;
      color: #475569;
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    .btn-pair-skip:active {
      background: #f8fafc;
    }

    .empty-settings {
      text-align: center;
      padding: 2rem 0;
      color: #94a3b8;
    }

    .empty-settings-title {
      font-size: 0.9375rem;
      font-weight: 500;
    }

    .empty-settings-sub {
      font-size: 0.8125rem;
      margin-top: 0.25rem;
    }

    /* Animations */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .spin {
      animation: spin 0.8s linear infinite;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.25s ease;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    /* =====================================================
       DC Metro Tracker
       Real-time WMATA train predictions PWA
       ===================================================== */

    // ── Configuration ──────────────────────────────────────
    const API_KEY = 'a904e787966948e39042f5055a178856';
    const REFRESH_INTERVAL_MS = 30000;
    const API_BASE = 'https://api.wmata.com/StationPrediction.svc/json/GetPrediction';

    // ── Station Data ───────────────────────────────────────
    const ALL_STATIONS = {
      'A01':'Metro Center','A02':'Farragut North','A03':'Dupont Circle',
      'A04':'Woodley Park-Zoo/Adams Morgan','A05':'Cleveland Park','A06':'Van Ness-UDC',
      'A07':'Tenleytown-AU','A08':'Friendship Heights','A09':'Bethesda',
      'A10':'Medical Center','A11':'Grosvenor-Strathmore','A12':'North Bethesda',
      'A13':'Twinbrook','A14':'Rockville','A15':'Shady Grove',
      'B01':'Gallery Pl-Chinatown','B02':'Judiciary Square','B03':'Union Station',
      'B04':'Rhode Island Ave-Brentwood','B05':'Brookland-CUA','B06':'Fort Totten',
      'B07':'Takoma','B08':'Silver Spring','B09':'Forest Glen',
      'B10':'Wheaton','B11':'Glenmont','B35':'NoMa-Gallaudet U',
      'C01':'Metro Center','C02':'McPherson Square','C03':'Farragut West',
      'C04':'Foggy Bottom-GWU','C05':'Rosslyn','C06':'Arlington Cemetery',
      'C07':'Pentagon','C08':'Pentagon City','C09':'Crystal City',
      'C10':'Ronald Reagan Washington National Airport','C11':'Potomac Yard',
      'C12':'Braddock Road','C13':'King St-Old Town','C14':'Eisenhower Avenue',
      'C15':'Huntington',
      'D01':'Federal Triangle','D02':'Smithsonian','D03':"L'Enfant Plaza",
      'D04':'Federal Center SW','D05':'Capitol South','D06':'Eastern Market',
      'D07':'Potomac Ave','D08':'Stadium-Armory','D09':'Minnesota Ave',
      'D10':'Deanwood','D11':'Cheverly','D12':'Landover','D13':'New Carrollton',
      'E01':'Mt Vernon Sq 7th St-Convention Center','E02':'Shaw-Howard U',
      'E03':'U Street/African-Amer Civil War Memorial/Cardozo',
      'E04':'Columbia Heights','E05':'Georgia Ave-Petworth','E06':'Fort Totten',
      'E07':'West Hyattsville','E08':'Hyattsville Crossing',
      'E09':'College Park-U of Md','E10':'Greenbelt',
      'F01':'Gallery Pl-Chinatown','F02':'Archives-Navy Memorial-Penn Quarter',
      'F03':"L'Enfant Plaza",'F04':'Waterfront','F05':'Navy Yard-Ballpark',
      'F06':'Anacostia','F07':'Congress Heights','F08':'Southern Avenue',
      'F09':'Naylor Road','F10':'Suitland','F11':'Branch Ave',
      'G01':'Benning Road','G02':'Capitol Heights',
      'G03':'Addison Road-Seat Pleasant','G04':'Morgan Boulevard','G05':'Downtown Largo',
      'J02':'Van Dorn Street','J03':'Franconia-Springfield',
      'K01':'Court House','K02':'Clarendon','K03':'Virginia Square-GMU',
      'K04':'Ballston-MU','K05':'East Falls Church','K06':'West Falls Church',
      'K07':'Dunn Loring-Merrifield','K08':'Vienna/Fairfax-GMU',
      'N01':'McLean','N02':'Tysons','N03':'Greensboro','N04':'Spring Hill',
      'N06':'Wiehle-Reston East','N07':'Reston Town Center','N08':'Herndon',
      'N09':'Innovation Center','N10':'Washington Dulles International Airport',
      'N11':'Loudoun Gateway','N12':'Ashburn'
    };

    // Stations with two platforms — need both codes for complete predictions
    const PAIRED_STATIONS = {
      'A01':'C01', 'C01':'A01',
      'B01':'F01', 'F01':'B01',
      'B06':'E06', 'E06':'B06',
      'D03':'F03', 'F03':'D03'
    };

    // Which lines serve which station codes (used for filter toggles)
    const STATION_LINES = {
      'A01':['RD'],'A02':['RD'],'A03':['RD'],'A04':['RD'],'A05':['RD'],
      'A06':['RD'],'A07':['RD'],'A08':['RD'],'A09':['RD'],'A10':['RD'],
      'A11':['RD'],'A12':['RD'],'A13':['RD'],'A14':['RD'],'A15':['RD'],
      'B01':['RD','YL','GR'],'B02':['RD'],'B03':['RD'],'B04':['RD'],
      'B05':['RD'],'B06':['RD','YL','GR'],'B07':['RD'],'B08':['RD'],
      'B09':['RD'],'B10':['RD'],'B11':['RD'],'B35':['RD'],
      'C01':['BL','OR','SV'],'C02':['BL','OR','SV'],'C03':['BL','OR','SV'],
      'C04':['BL','OR','SV'],'C05':['BL','OR','SV'],'C06':['BL'],
      'C07':['BL','YL'],'C08':['BL','YL'],'C09':['BL','YL'],
      'C10':['BL','YL'],'C11':['BL','YL'],'C12':['BL','YL'],
      'C13':['BL','YL'],'C14':['YL'],'C15':['YL'],
      'D01':['BL','OR','SV'],'D02':['BL','OR','SV'],
      'D03':['BL','OR','SV'],'D04':['BL','OR','SV'],
      'D05':['BL','OR','SV'],'D06':['BL','OR','SV'],
      'D07':['BL','OR','SV'],'D08':['BL','OR','SV'],
      'D09':['OR'],'D10':['OR'],'D11':['OR'],'D12':['OR'],'D13':['OR'],
      'E01':['YL','GR'],'E02':['YL','GR'],'E03':['YL','GR'],
      'E04':['YL','GR'],'E05':['YL','GR'],'E06':['YL','GR'],
      'E07':['GR'],'E08':['GR'],'E09':['GR'],'E10':['GR'],
      'F01':['YL','GR'],'F02':['YL','GR'],'F03':['YL','GR'],
      'F04':['GR'],'F05':['GR'],'F06':['GR'],'F07':['GR'],
      'F08':['GR'],'F09':['GR'],'F10':['GR'],'F11':['GR'],
      'G01':['BL','SV'],'G02':['BL','SV'],'G03':['BL','SV'],
      'G04':['BL','SV'],'G05':['BL','SV'],
      'J02':['BL'],'J03':['BL'],
      'K01':['OR','SV'],'K02':['OR','SV'],'K03':['OR','SV'],
      'K04':['OR','SV'],'K05':['OR','SV'],'K06':['OR'],
      'K07':['OR'],'K08':['OR'],
      'N01':['SV'],'N02':['SV'],'N03':['SV'],'N04':['SV'],
      'N06':['SV'],'N07':['SV'],'N08':['SV'],'N09':['SV'],
      'N10':['SV'],'N11':['SV'],'N12':['SV']
    };

    const LINE_COLORS = {
      'RD': '#ef4444', 'BL': '#3b82f6', 'YL': '#eab308',
      'OR': '#f97316', 'GR': '#22c55e', 'SV': '#9ca3af'
    };

    const LINE_NAMES = {
      'RD': 'Red', 'BL': 'Blue', 'YL': 'Yellow',
      'OR': 'Orange', 'GR': 'Green', 'SV': 'Silver'
    };

    // ── Application State ──────────────────────────────────
    let state = {
      stations: [],        // Array of station codes the user has added
      predictions: {},     // { stationCode: [train, train, ...] }
      collapsed: {},       // { stationCode: true/false }
      lineFilters: {},     // { stationCode: { 'RD': true, 'BL': false, ... } }
      loading: false,
      error: '',
      showSettings: false,
      searchQuery: '',
      lastUpdate: null,
      pairSuggestion: null,
      refreshTimer: null
    };

    // ── Persistence ────────────────────────────────────────
    const STORAGE_KEY = 'dcMetroTracker';

    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          state.stations = data.stations || [];
          state.collapsed = data.collapsed || {};
          state.lineFilters = data.lineFilters || {};
        }
      } catch (e) {
        console.warn('Failed to load saved state:', e);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          stations: state.stations,
          collapsed: state.collapsed,
          lineFilters: state.lineFilters
        }));
      } catch (e) {
        console.warn('Failed to save state:', e);
      }
    }

    // ── API ────────────────────────────────────────────────
    async function fetchPredictions() {
      if (!state.stations.length) return;

      state.loading = true;
      state.error = '';
      renderSafe();

      try {
        const newPredictions = {};
        for (const code of state.stations) {
          const res = await fetch(`${API_BASE}/${code}`, {
            headers: { 'api_key': API_KEY }
          });
          if (!res.ok) {
            throw new Error(`API returned ${res.status} for station ${code}`);
          }
          const data = await res.json();
          newPredictions[code] = (data.Trains || []).filter(
            t => t.DestinationName !== 'No Passenger' && t.Line !== 'No' && t.Line !== '--'
          );
        }
        state.predictions = newPredictions;
        state.lastUpdate = new Date();
      } catch (e) {
        state.error = e.message || 'Failed to fetch predictions';
      } finally {
        state.loading = false;
        renderSafe();
      }
    }

    // Render that preserves search input focus when settings is open
    function renderSafe() {
      if (state.showSettings) {
        const input = document.getElementById('searchInput');
        const hadFocus = input && document.activeElement === input;
        const cursorPos = hadFocus ? input.selectionStart : 0;

        render();

        if (hadFocus) {
          requestAnimationFrame(() => {
            const newInput = document.getElementById('searchInput');
            if (newInput) {
              newInput.focus();
              newInput.setSelectionRange(cursorPos, cursorPos);
            }
          });
        }
      } else {
        render();
      }
    }

    // ── Refresh Management ─────────────────────────────────
    function startRefresh() {
      stopRefresh();
      if (state.stations.length > 0) {
        fetchPredictions();
        state.refreshTimer = setInterval(fetchPredictions, REFRESH_INTERVAL_MS);
      }
    }

    function stopRefresh() {
      if (state.refreshTimer) {
        clearInterval(state.refreshTimer);
        state.refreshTimer = null;
      }
    }

    // Pause refresh when tab is hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopRefresh();
      } else if (state.stations.length > 0) {
        startRefresh();
      }
    });

    // ── Station Management ─────────────────────────────────
    function addStation(code) {
      if (!ALL_STATIONS[code] || state.stations.includes(code)) return;

      state.stations.push(code);

      // Initialize line filters — all lines enabled by default
      const lines = getStationLines(code);
      const filters = {};
      lines.forEach(l => filters[l] = true);
      state.lineFilters[code] = filters;

      // Check for paired platform
      if (PAIRED_STATIONS[code] && !state.stations.includes(PAIRED_STATIONS[code])) {
        state.pairSuggestion = PAIRED_STATIONS[code];
      }

      state.searchQuery = '';
      saveState();
      render();
      startRefresh();
    }

    function removeStation(code) {
      state.stations = state.stations.filter(c => c !== code);
      delete state.predictions[code];
      delete state.collapsed[code];
      delete state.lineFilters[code];
      saveState();
      render();

      if (state.stations.length === 0) {
        stopRefresh();
      }
    }

    function addPairedStation(code) {
      state.pairSuggestion = null;
      addStation(code);
    }

    function dismissPairSuggestion() {
      state.pairSuggestion = null;
      render();
    }

    function toggleCollapse(code) {
      state.collapsed[code] = !state.collapsed[code];
      saveState();
      render();
    }

    function toggleLineFilter(stationCode, line) {
      if (!state.lineFilters[stationCode]) return;
      state.lineFilters[stationCode][line] = !state.lineFilters[stationCode][line];
      saveState();
      render();
    }

    function getStationLines(code) {
      // For paired stations, combine lines from both platforms
      const lines = new Set(STATION_LINES[code] || []);
      const pair = PAIRED_STATIONS[code];
      if (pair && state.stations.includes(pair)) {
        (STATION_LINES[pair] || []).forEach(l => lines.add(l));
      }
      return Array.from(lines).sort();
    }

    function getFilteredTrains(code) {
      const trains = state.predictions[code] || [];
      const filters = state.lineFilters[code];
      if (!filters) return trains;

      return trains.filter(t => {
        if (!t.Line || !LINE_COLORS[t.Line]) return true; // show unknown lines
        return filters[t.Line] !== false; // show if filter is true or undefined
      });
    }

    // ── Helpers ────────────────────────────────────────────
    function getStationsByName() {
      return Object.entries(ALL_STATIONS)
        .map(([code, name]) => ({ code, name }))
        .sort((a, b) => a.name.localeCompare(b.name));
    }

    function formatTime(min) {
      if (min === 'ARR') return 'ARR';
      if (min === 'BRD') return 'BRD';
      if (min === '---' || min === '' || min == null) return '---';
      return `${min} min`;
    }

    function isArriving(min) {
      return min === 'ARR' || min === 'BRD';
    }

    function getLineColor(line) {
      return LINE_COLORS[line] || '#6b7280';
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // ── Icons (inline SVG) ─────────────────────────────────
    const ICONS = {
      train: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3" width="16" height="14" rx="2"/><path d="M4 10h16"/><path d="M12 3v7"/><circle cx="8" cy="21" r="1"/><circle cx="16" cy="21" r="1"/><path d="M6 17l-2 4"/><path d="M18 17l2 4"/></svg>`,
      refresh: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>`,
      settings: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
      clock: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
      alert: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
      info: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>`,
      chevron: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>`,
      plus: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`
    };

    // ── Rendering ──────────────────────────────────────────
    function render() {
      const app = document.getElementById('app');
      app.innerHTML = renderMain() + renderSettingsPanel();
    }

    function renderMain() {
      return `
        <div class="app">
          <div class="container">
            ${renderHeader()}
            ${state.lastUpdate ? renderStatusBar() : ''}
            ${state.error ? renderError() : ''}
            ${state.stations.length === 0 ? renderEmptyState() : renderStationCards()}
          </div>
        </div>
      `;
    }

    function renderHeader() {
      return `
        <div class="header">
          <div class="header-left">
            <div class="header-icon">${ICONS.train}</div>
            <h1 class="header-title">Metro Tracker</h1>
          </div>
          <div class="header-buttons">
            <button class="icon-btn${state.loading ? ' spin-container' : ''}" onclick="handleRefresh()" ${state.loading ? 'disabled' : ''} aria-label="Refresh">
              <span class="${state.loading ? 'spin' : ''}">${ICONS.refresh}</span>
            </button>
            <button class="icon-btn" onclick="openSettings()" aria-label="Settings">
              ${ICONS.settings}
            </button>
          </div>
        </div>
      `;
    }

    function renderStatusBar() {
      const time = state.lastUpdate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      return `
        <div class="status-bar">
          ${ICONS.clock}
          <span>Updated ${time}</span>
        </div>
      `;
    }

    function renderError() {
      return `
        <div class="alert fade-in">
          ${ICONS.alert}
          <div>
            <div class="alert-title">Connection Error</div>
            <div class="alert-text">${escapeHtml(state.error)}</div>
          </div>
        </div>
      `;
    }

    function renderEmptyState() {
      return `
        <div class="empty-state fade-in">
          ${ICONS.train}
          <div class="empty-title">No stations added</div>
          <div class="empty-subtitle">Add your favorite Metro stations to see live arrivals</div>
          <button class="btn-primary" onclick="openSettings()">
            ${ICONS.plus} Add Stations
          </button>
        </div>
      `;
    }

    function renderStationCards() {
      return state.stations.map(code => {
        const name = ALL_STATIONS[code] || code;
        const isCollapsed = state.collapsed[code] === true;
        const trains = getFilteredTrains(code);
        const trainCount = trains.length;

        return `
          <div class="station-card fade-in">
            <div class="station-header" onclick="toggleCollapse('${code}')">
              <div class="station-header-left">
                <div class="collapse-arrow ${isCollapsed ? '' : 'expanded'}">${ICONS.chevron}</div>
                <div class="station-name">${escapeHtml(name)}</div>
              </div>
              <div class="station-badge">${isCollapsed ? (trainCount > 0 ? `${trainCount} train${trainCount !== 1 ? 's' : ''}` : '') : ''}</div>
            </div>
            <div class="station-trains ${isCollapsed ? 'collapsed' : 'expanded'}" style="${!isCollapsed ? `max-height: ${Math.max(trainCount * 70 + 20, 80)}px` : ''}">
              <div class="trains-inner">
                ${trainCount > 0 ? trains.map(renderTrainItem).join('') : renderNoTrains()}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTrainItem(train) {
      const color = getLineColor(train.Line);
      const dest = train.DestinationName || train.Destination || 'Unknown';
      const time = formatTime(train.Min);
      const arriving = isArriving(train.Min);
      const cars = train.Car && train.Car !== '-' && train.Car !== '' ? `${train.Car}-car` : '';
      const line = LINE_NAMES[train.Line] || train.Line || '';

      return `
        <div class="train-item">
          <div class="train-left">
            <div class="line-dot" style="background-color: ${color}"></div>
            <div class="train-info">
              <div class="train-dest">${escapeHtml(dest)}</div>
              <div class="train-meta">${[line, cars].filter(Boolean).join(' · ')}</div>
            </div>
          </div>
          <div class="train-time${arriving ? ' arriving' : ''}">${time}</div>
        </div>
      `;
    }

    function renderNoTrains() {
      return `<div class="no-trains">${state.loading ? 'Loading...' : 'No trains scheduled'}</div>`;
    }

    // ── Settings Panel ─────────────────────────────────────
    function renderSettingsPanel() {
      const stationsByName = getStationsByName();
      const query = state.searchQuery.toLowerCase();
      const results = query
        ? stationsByName.filter(s =>
            s.name.toLowerCase().includes(query) || s.code.toLowerCase().includes(query)
          ).slice(0, 10)
        : [];

      return `
        <div class="settings-overlay ${state.showSettings ? 'visible' : ''}" onclick="closeSettings()"></div>
        <div class="settings-panel ${state.showSettings ? 'visible' : ''}">
          <div class="settings-inner">
            <div class="settings-header">
              <h2 class="settings-title">Settings</h2>
              <button class="btn-done" onclick="closeSettings()">Done</button>
            </div>

            ${state.pairSuggestion ? renderPairSuggestion() : ''}

            <div class="search-group">
              <label class="search-label">Add Station</label>
              <input
                type="text"
                class="search-input"
                id="searchInput"
                placeholder="Search by station name..."
                value="${escapeHtml(state.searchQuery)}"
                oninput="handleSearchInput(event)"
                autocomplete="off"
                autocapitalize="off"
                spellcheck="false"
              >
            </div>

            ${query ? renderSearchResults(results) : ''}

            ${state.stations.length > 0 ? renderStationList() : renderEmptySettingsList()}
          </div>
        </div>
      `;
    }

    function renderPairSuggestion() {
      const code = state.pairSuggestion;
      const name = ALL_STATIONS[code] || code;
      return `
        <div class="pair-banner">
          ${ICONS.info}
          <div class="pair-content">
            <div class="pair-title">Multi-platform station</div>
            <div class="pair-text">${escapeHtml(name)} has another platform. Add it for complete predictions?</div>
            <div class="pair-buttons">
              <button class="btn-pair-add" onclick="addPairedStation('${code}')">Add Platform</button>
              <button class="btn-pair-skip" onclick="dismissPairSuggestion()">Skip</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderSearchResults(results) {
      if (results.length === 0) {
        return `<div style="color: #94a3b8; text-align: center; padding: 1rem 0; font-size: 0.875rem;">No stations found</div>`;
      }

      return `
        <div class="search-results">
          ${results.map(s => {
            const added = state.stations.includes(s.code);
            return `
              <button
                class="search-item"
                onclick="addStation('${s.code}')"
                ${added ? 'disabled' : ''}
              >
                <span class="search-item-name">${escapeHtml(s.name)}</span>
                <span class="search-item-badge">${added ? 'Added' : s.code}</span>
              </button>
            `;
          }).join('')}
        </div>
      `;
    }

    function renderStationList() {
      return `
        <div class="section-label">Your Stations (${state.stations.length})</div>
        ${state.stations.map(code => {
          const name = ALL_STATIONS[code] || code;
          const lines = getStationLines(code);
          const filters = state.lineFilters[code] || {};

          return `
            <div class="station-list-item">
              <div class="station-list-top">
                <span class="station-list-name">${escapeHtml(name)}</span>
                <button class="btn-remove" onclick="removeStation('${code}')">Remove</button>
              </div>
              ${lines.length > 0 ? `
                <div class="line-filters">
                  <div class="line-filter-label">Show lines:</div>
                  ${lines.map(line => {
                    const active = filters[line] !== false;
                    const color = LINE_COLORS[line];
                    return `
                      <button
                        class="line-toggle ${active ? 'active' : ''}"
                        style="${active ? `color: ${color}; border-color: ${color}; background: ${color}` : ''}"
                        onclick="toggleLineFilter('${code}', '${line}')"
                      >
                        <span class="line-toggle-dot" style="background: ${color}"></span>
                        <span class="line-toggle-text">${line}</span>
                      </button>
                    `;
                  }).join('')}
                </div>
              ` : ''}
            </div>
          `;
        }).join('')}
      `;
    }

    function renderEmptySettingsList() {
      return `
        <div class="empty-settings">
          <div class="empty-settings-title">No stations added yet</div>
          <div class="empty-settings-sub">Search above to add your favorite stations</div>
        </div>
      `;
    }

    // ── Event Handlers ─────────────────────────────────────
    function handleRefresh() {
      fetchPredictions();
    }

    function openSettings() {
      state.showSettings = true;
      state.searchQuery = '';
      render();
      // Focus search input after render
      requestAnimationFrame(() => {
        const input = document.getElementById('searchInput');
        if (input) input.focus();
      });
    }

    function closeSettings() {
      state.showSettings = false;
      state.searchQuery = '';
      state.pairSuggestion = null;
      render();
    }

    function handleSearchInput(e) {
      state.searchQuery = e.target.value;
      const cursorPos = e.target.selectionStart;

      render();

      // Restore focus and cursor position after re-render
      requestAnimationFrame(() => {
        const newInput = document.getElementById('searchInput');
        if (newInput) {
          newInput.focus();
          newInput.setSelectionRange(cursorPos, cursorPos);
        }
      });
    }

    // ── Service Worker Registration ────────────────────────
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js').catch(err => {
          console.log('Service Worker registration failed (expected when running locally):', err);
        });
      });
    }

    // ── Initialize ─────────────────────────────────────────
    function init() {
      loadState();
      render();
      if (state.stations.length > 0) {
        startRefresh();
      }
    }

    init();
  </script>
</body>
</html>
