<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Metro">
  <title>DC Metro Tracker</title>
  
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiMyZDZhNGYiLz4KPHJlY3QgeD0iMzAiIHk9IjUwIiB3aWR0aD0iMzAiIGhlaWdodD0iODAiIGZpbGw9IndoaXRlIi8+CjxyZWN0IHg9Ijc1IiB5PSI1MCIgd2lkdGg9IjMwIiBoZWlnaHQ9IjgwIiBmaWxsPSJ3aGl0ZSIvPgo8cmVjdCB4PSIxMjAiIHk9IjUwIiB3aWR0aD0iMzAiIGhlaWdodD0iODAiIGZpbGw9IndoaXRlIi8+CjxyZWN0IHg9IjMwIiB5PSI1MCIgd2lkdGg9IjEyMCIgaGVpZ2h0PSIyMCIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg==">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      overscroll-behavior-y: contain;
      background: #f4f1eb;
      color: #2c2c2c;
    }
    .app { min-height: 100vh; padding: 1rem; padding-top: 1.25rem; padding-bottom: 5rem; }
    .container { max-width: 48rem; margin: 0 auto; }

    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; }
    .header-left { display: flex; align-items: center; gap: 0.6rem; }
    .header-title { font-size: 1.4rem; font-weight: 700; color: #2d6a4f; }
    .header-buttons { display: flex; gap: 0.5rem; }
    .icon-btn {
      padding: 0.5rem; background: #2d6a4f;
      border: none; border-radius: 0.6rem;
      color: white; cursor: pointer; transition: background 0.2s;
    }
    .icon-btn:hover:not(:disabled) { background: #245a42; }
    .icon-btn:disabled { opacity: 0.45; }

    .last-update { color: #6b7264; font-size: 0.8rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.4rem; }

    .card {
      background: #ffffff; border: 1px solid #ddd8cf;
      border-radius: 0.85rem; padding: 1rem; margin-bottom: 0.85rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .station-name { font-size: 1.05rem; font-weight: 700; color: #2d6a4f; margin-bottom: 0.4rem; }

    .direction-group { margin-bottom: 0.6rem; }
    .direction-group:last-child { margin-bottom: 0; }
    .direction-label {
      font-size: 0.68rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;
      color: #8a8477; padding: 0.2rem 0.1rem; margin-bottom: 0.25rem;
      display: flex; align-items: center; gap: 0.35rem;
    }
    .direction-arrow { font-size: 0.6rem; color: #a09a8e; }
    .direction-divider { height: 1px; background: #e8e4dc; margin: 0.55rem 0; }

    .train-item {
      background: #fafaf7; border: 1px solid #eae6de;
      border-radius: 0.55rem; padding: 0.65rem 0.75rem;
      display: flex; align-items: center; justify-content: space-between; margin-top: 0.3rem;
    }
    .train-left { display: flex; align-items: center; gap: 0.65rem; flex: 1; }
    .line-dot { width: 0.55rem; height: 0.55rem; border-radius: 9999px; flex-shrink: 0; }
    .train-info { flex: 1; }
    .train-dest { color: #2c2c2c; font-weight: 500; font-size: 0.92rem; }
    .train-cars { color: #8a8477; font-size: 0.72rem; margin-top: 0.1rem; }
    .train-time { color: #2d6a4f; font-weight: 700; font-size: 1.05rem; text-align: right; white-space: nowrap; padding-left: 0.75rem; }
    .train-time-arriving { color: #b45309; }

    .empty-state {
      background: #ffffff; border: 1px solid #ddd8cf;
      border-radius: 0.85rem; padding: 2.5rem 1.5rem; text-align: center;
    }
    .empty-icon { width: 2.5rem; height: 2.5rem; color: #a09a8e; margin: 0 auto 0.75rem; }
    .empty-text { color: #8a8477; text-align: center; padding: 0.75rem 0; font-size: 0.88rem; }

    .btn-primary {
      padding: 0.55rem 1.5rem; background: #2d6a4f; color: white;
      border: none; border-radius: 0.55rem; font-weight: 600; font-size: 0.92rem; cursor: pointer;
    }
    .btn-primary:hover { background: #245a42; }

    .card-white {
      background: white; border: 1px solid #ddd8cf;
      border-radius: 0.85rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 1.5rem;
    }
    .settings-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; }
    .settings-title { font-size: 1.15rem; font-weight: 700; color: #2c2c2c; }
    .btn-link { color: #2d6a4f; font-weight: 600; background: none; border: none; cursor: pointer; padding: 0; font-size: 0.95rem; }
    .btn-link:hover { color: #245a42; }

    .input-group { margin-bottom: 1.25rem; }
    .input-label { display: block; font-size: 0.82rem; font-weight: 600; color: #5a5a5a; margin-bottom: 0.4rem; }
    .input {
      width: 100%; padding: 0.55rem 0.85rem;
      border: 1px solid #d1cdc4; border-radius: 0.5rem;
      font-size: 1rem; background: #fafaf7; color: #2c2c2c;
    }
    .input:focus { outline: none; border-color: #2d6a4f; box-shadow: 0 0 0 3px rgba(45, 106, 79, 0.12); }

    .search-results { max-height: 16rem; overflow-y: auto; margin-bottom: 1.25rem; }
    .search-item {
      width: 100%; padding: 0.7rem 0.85rem; text-align: left;
      border: 1px solid #e0dcd4; border-radius: 0.5rem;
      background: #fafaf7; cursor: pointer; margin-bottom: 0.4rem; transition: background 0.15s;
    }
    .search-item:hover:not(:disabled) { background: #eef5ec; border-color: #b5ccba; }
    .search-item:disabled { background: #f0ede8; color: #aaa69e; cursor: not-allowed; }
    .search-item-name { font-weight: 500; color: #2c2c2c; }
    .search-item-code { font-size: 0.72rem; color: #8a8477; margin-top: 0.1rem; }

    .station-list-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.7rem 0.75rem; background: #fafaf7;
      border: 1px solid #e8e4dc; border-radius: 0.5rem; margin-bottom: 0.4rem;
    }
    .station-list-name { font-weight: 500; color: #2c2c2c; }
    .btn-remove { color: #c0392b; font-size: 0.82rem; font-weight: 600; background: none; border: none; cursor: pointer; padding: 0; }
    .btn-remove:hover { color: #a5311f; }

    .alert {
      background: #fef2f2; border: 1px solid #f5c6c6;
      border-radius: 0.6rem; padding: 0.85rem; margin-bottom: 0.85rem; display: flex; gap: 0.6rem;
    }
    .alert-title { color: #991b1b; font-weight: 600; font-size: 0.88rem; }
    .alert-text { color: #b91c1c; font-size: 0.82rem; }

    .info-banner {
      background: #eef5ec; border: 1px solid #b5ccba;
      border-radius: 0.6rem; padding: 0.85rem; margin-bottom: 1.25rem; display: flex; gap: 0.6rem;
    }
    .info-content { flex: 1; }
    .info-title { font-size: 0.85rem; font-weight: 600; color: #2d6a4f; }
    .info-text { font-size: 0.82rem; color: #3a7d5c; margin-top: 0.2rem; }
    .info-buttons { display: flex; gap: 0.5rem; margin-top: 0.65rem; }
    .btn-info { padding: 0.45rem 0.85rem; background: #2d6a4f; color: white; border: none; border-radius: 0.45rem; font-size: 0.82rem; font-weight: 500; cursor: pointer; }
    .btn-info:hover { background: #245a42; }
    .btn-info-secondary { padding: 0.45rem 0.85rem; background: white; color: #5a5a5a; border: 1px solid #d1cdc4; border-radius: 0.45rem; font-size: 0.82rem; cursor: pointer; }
    .btn-info-secondary:hover { background: #f4f1eb; }

    .empty-settings { text-align: center; padding: 2rem 0; color: #8a8477; }

    .line-filters { display: flex; flex-wrap: wrap; gap: 0.3rem; margin: 0.3rem 0 0.15rem 0; }
    .line-filter-btn {
      padding: 0.2rem 0.55rem; font-size: 0.7rem; font-weight: 600;
      border: 1.5px solid #d1cdc4; border-radius: 999px;
      background: #fafaf7; color: #6b7264; cursor: pointer;
      transition: all 0.15s ease; line-height: 1.3;
    }
    .line-filter-btn:hover { border-color: #a09a8e; }

    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    const API_KEY = 'a904e787966948e39042f5055a178856';
    const allStations = {'A01':'Metro Center','A02':'Farragut North','A03':'Dupont Circle','A04':'Woodley Park-Zoo/Adams Morgan','A05':'Cleveland Park','A06':'Van Ness-UDC','A07':'Tenleytown-AU','A08':'Friendship Heights','A09':'Bethesda','A10':'Medical Center','A11':'Grosvenor-Strathmore','A12':'North Bethesda','A13':'Twinbrook','A14':'Rockville','A15':'Shady Grove','B01':'Gallery Pl-Chinatown','B02':'Judiciary Square','B03':'Union Station','B04':'Rhode Island Ave-Brentwood','B05':'Brookland-CUA','B06':'Fort Totten','B07':'Takoma','B08':'Silver Spring','B09':'Forest Glen','B10':'Wheaton','B11':'Glenmont','B35':'NoMa-Gallaudet U','C01':'Metro Center','C02':'McPherson Square','C03':'Farragut West','C04':'Foggy Bottom-GWU','C05':'Rosslyn','C06':'Arlington Cemetery','C07':'Pentagon','C08':'Pentagon City','C09':'Crystal City','C10':'Ronald Reagan Washington National Airport','C11':'Potomac Yard','C12':'Braddock Road','C13':'King St-Old Town','C14':'Eisenhower Avenue','C15':'Huntington','D01':'Federal Triangle','D02':'Smithsonian','D03':"L'Enfant Plaza",'D04':'Federal Center SW','D05':'Capitol South','D06':'Eastern Market','D07':'Potomac Ave','D08':'Stadium-Armory','D09':'Minnesota Ave','D10':'Deanwood','D11':'Cheverly','D12':'Landover','D13':'New Carrollton','E01':'Mt Vernon Sq 7th St-Convention Center','E02':'Shaw-Howard U','E03':'U Street/African-Amer Civil War Memorial/Cardozo','E04':'Columbia Heights','E05':'Georgia Ave-Petworth','E06':'Fort Totten','E07':'West Hyattsville','E08':'Hyattsville Crossing','E09':'College Park-U of Md','E10':'Greenbelt','F01':'Gallery Pl-Chinatown','F02':'Archives-Navy Memorial-Penn Quarter','F03':"L'Enfant Plaza",'F04':'Waterfront','F05':'Navy Yard-Ballpark','F06':'Anacostia','F07':'Congress Heights','F08':'Southern Avenue','F09':'Naylor Road','F10':'Suitland','F11':'Branch Ave','G01':'Benning Road','G02':'Capitol Heights','G03':'Addison Road-Seat Pleasant','G04':'Morgan Boulevard','G05':'Downtown Largo','J02':'Van Dorn Street','J03':'Franconia-Springfield','K01':'Court House','K02':'Clarendon','K03':'Virginia Square-GMU','K04':'Ballston-MU','K05':'East Falls Church','K06':'West Falls Church','K07':'Dunn Loring-Merrifield','K08':'Vienna/Fairfax-GMU','N01':'McLean','N02':'Tysons','N03':'Greensboro','N04':'Spring Hill','N06':'Wiehle-Reston East','N07':'Reston Town Center','N08':'Herndon','N09':'Innovation Center','N10':'Washington Dulles International Airport','N11':'Loudoun Gateway','N12':'Ashburn'};
    const pairedStations = {'A01':'C01','C01':'A01','B01':'F01','F01':'B01','B06':'E06','E06':'B06','D03':'F03','F03':'D03'};

    let stations=[],predictions={},loading=false,error='',showSettings=false,stationInput='',lastUpdate=null,showPairSuggestion=null,refreshInterval=null;

    function init(){
      const s=localStorage.getItem('metroTrackerStations');
      if(s){try{stations=JSON.parse(s)}catch(e){}}
      render();
      if(stations.length>0){fetchPredictions();refreshInterval=setInterval(fetchPredictions,30000)}
    }

    function saveStations(){
      stations.length>0?localStorage.setItem('metroTrackerStations',JSON.stringify(stations)):localStorage.removeItem('metroTrackerStations')
    }

    async function fetchPredictions(){
      if(!stations.length)return;
      loading=true;error='';predictions={};render();
      try{
        for(const c of stations){
          const r=await fetch(`https://api.wmata.com/StationPrediction.svc/json/GetPrediction/${c}`,{headers:{'api_key':API_KEY}});
          if(!r.ok)throw new Error(`Failed to fetch data for ${c}`);
          const d=await r.json();
          predictions[c]=d.Trains||[]
        }
        lastUpdate=new Date()
      }catch(e){error=e.message}finally{loading=false;render()}
    }

    function addStation(c){
      const u=c.trim().toUpperCase();
      if(u&&allStations[u]&&!stations.includes(u)){
        stations.push(u);saveStations();stationInput='';
        if(pairedStations[u]){const p=pairedStations[u];if(!stations.includes(p))showPairSuggestion=p}
        render();
        if(refreshInterval)clearInterval(refreshInterval);
        fetchPredictions();refreshInterval=setInterval(fetchPredictions,30000)
      }
    }

    function addStationPair(p){
      if(!stations.includes(p)){stations.push(p);saveStations()}
      showPairSuggestion=null;render();
      if(refreshInterval)clearInterval(refreshInterval);
      fetchPredictions();refreshInterval=setInterval(fetchPredictions,30000)
    }

    function removeStation(c){
      stations=stations.filter(s=>s!==c);saveStations();delete predictions[c];render();
      if(!stations.length&&refreshInterval){clearInterval(refreshInterval);refreshInterval=null}
    }

    function getLineColor(l){
      const c={'RD':'#dc2626','BL':'#2563eb','YL':'#ca8a04','OR':'#ea580c','GR':'#16a34a','SV':'#71717a'};
      return c[l]||'#71717a'
    }

    function getLineName(l){
      const n={'RD':'Red','BL':'Blue','YL':'Yellow','OR':'Orange','GR':'Green','SV':'Silver'};
      return n[l]||l
    }

    // Light tinted backgrounds for active filter buttons
    function getLineFilterBg(l){
      const c={'RD':'rgba(220,38,38,0.12)','BL':'rgba(37,99,235,0.12)','YL':'rgba(202,138,4,0.12)','OR':'rgba(234,88,12,0.12)','GR':'rgba(22,163,74,0.12)','SV':'rgba(113,113,122,0.12)'};
      return c[l]||'rgba(113,113,122,0.1)'
    }

    // Filter state: lineFilters[stationCode-groupKey] = Set of active line codes (empty = show all)
    let lineFilters = {};

    function getFilterKey(stationCode, groupKey){ return stationCode+'-'+groupKey; }

    function toggleLineFilter(stationCode, groupKey, line){
      const key = getFilterKey(stationCode, groupKey);
      if(!lineFilters[key]) lineFilters[key] = new Set();
      if(lineFilters[key].has(line)) lineFilters[key].delete(line);
      else lineFilters[key].add(line);
      // If all are deselected, clear filter (show all)
      if(lineFilters[key].size === 0) delete lineFilters[key];
      render();
    }

    function isLineVisible(stationCode, groupKey, line){
      const key = getFilterKey(stationCode, groupKey);
      if(!lineFilters[key]) return true; // no filter = show all
      return lineFilters[key].has(line);
    }

    function formatDestName(name){
      return name.replace(/\//g, ' & ');
    }

    function formatTime(m){
      if(m==='ARR'||m==='BRD') return m;
      return `${m} min`;
    }

    function isArriving(m){ return m==='ARR'||m==='BRD'; }

    function getStationsByName(){
      return Object.entries(allStations).map(([c,n])=>({code:c,name:n})).sort((a,b)=>a.name.localeCompare(b.name))
    }

    const specialTrains = new Set(['train','no passenger','no psngrs','lasttrain','last train']);

    function isSpecialTrain(t){
      const dest = (t.Destination||'').toLowerCase().trim();
      const destName = (t.DestinationName||'').toLowerCase().trim();
      return specialTrains.has(dest) || specialTrains.has(destName) || dest==='' || t.DestinationCode===null || t.DestinationCode==='';
    }

    function getFullDestination(t){
      let name;
      if(t.DestinationCode && allStations[t.DestinationCode]) name = allStations[t.DestinationCode];
      else if(t.DestinationName && t.DestinationName.length > 2) name = t.DestinationName;
      else name = t.Destination || 'Unknown';
      return formatDestName(name);
    }

    function getSpecialLabel(t){
      const dest = (t.Destination||'').toLowerCase().trim();
      if(dest==='lasttrain' || dest==='last train') return 'Last Train';
      if(dest==='no psngrs' || (t.DestinationName||'').toLowerCase()==='no passenger') return 'Not In Service';
      return 'Special';
    }

    function groupTrainsByDirection(trains){
      const groups={};
      for(const t of trains){const g=t.Group||'?';if(!groups[g])groups[g]=[];groups[g].push(t)}
      return groups;
    }

    function getDirectionLabel(trains){
      const dests=[],seen=new Set();
      for(const t of trains){
        if(isSpecialTrain(t)) continue;
        const name=getFullDestination(t);
        if(name&&!seen.has(name)){seen.add(name);dests.push(name)}
      }
      return dests.length?'Toward '+dests.join(', '):'Trains';
    }

    function renderTrainItem(t){
      const arriving=isArriving(t.Min);
      const special=isSpecialTrain(t);
      const destDisplay=special?getSpecialLabel(t):(getLineName(t.Line)+' to '+getFullDestination(t));
      return`<div class="train-item"><div class="train-left"><div class="line-dot"style="background-color:${special?'#a09a8e':getLineColor(t.Line)}"></div><div class="train-info"><div class="train-dest"style="${special?'color:#8a8477;font-style:italic':''}">${destDisplay}</div>${t.Car&&!special?`<div class="train-cars">${t.Car} cars</div>`:''}</div></div><div class="train-time${arriving?' train-time-arriving':''}">${formatTime(t.Min)}</div></div>`;
    }

    function renderStationCard(c){
      const trains=predictions[c];
      if(!trains||!trains.length)return`<div class="card"><h2 class="station-name">${formatDestName(allStations[c])}</h2><div class="empty-text">${loading?'Loading...':'No trains scheduled'}</div></div>`;
      const grouped=groupTrainsByDirection(trains);
      const keys=Object.keys(grouped).sort();
      let h=`<div class="card"><h2 class="station-name">${formatDestName(allStations[c])}</h2>`;
      keys.forEach((k,i)=>{
        const dt=grouped[k];
        // Get unique lines in this direction for filter buttons
        const linesInGroup=[];
        const seenLines=new Set();
        for(const t of dt){
          if(!isSpecialTrain(t)&&t.Line&&!seenLines.has(t.Line)){seenLines.add(t.Line);linesInGroup.push(t.Line)}
        }
        // Filter trains by selected lines
        const filterKey=getFilterKey(c,k);
        const hasFilter=!!lineFilters[filterKey];
        const filteredTrains=dt.filter(t=>{
          if(isSpecialTrain(t)) return true; // always show special
          return isLineVisible(c,k,t.Line);
        });

        h+=`<div class="direction-group">`;
        h+=`<div class="direction-label"><span class="direction-arrow">â–¸</span> ${getDirectionLabel(dt)}</div>`;
        // Line filter buttons (only show if more than one line serves this direction)
        if(linesInGroup.length>1){
          h+=`<div class="line-filters">`;
          for(const line of linesInGroup){
            const active=hasFilter?lineFilters[filterKey].has(line):false;
            const bg=active?getLineFilterBg(line):'transparent';
            const border=active?getLineColor(line):'#d1cdc4';
            const color=active?getLineColor(line):'#6b7264';
            h+=`<button class="line-filter-btn"onclick="toggleLineFilter('${c}','${k}','${line}')"style="background:${bg};border-color:${border};color:${color}">${getLineName(line)}</button>`;
          }
          h+=`</div>`;
        }
        h+=filteredTrains.map(renderTrainItem).join('');
        h+=`</div>`;
        if(i<keys.length-1)h+=`<div class="direction-divider"></div>`;
      });
      return h+'</div>';
    }

    function render(){document.getElementById('app').innerHTML=showSettings?renderSettings():renderMain();attachEventListeners()}

    function renderSettings(){
      const sb=getStationsByName();
      const f=stationInput?sb.filter(({name,code})=>name.toLowerCase().includes(stationInput.toLowerCase())||code.toLowerCase().includes(stationInput.toLowerCase())).slice(0,10):[];
      return`<div class="app"><div class="container"><div class="card-white"><div class="settings-header"><h2 class="settings-title">Station Settings</h2><button class="btn-link"onclick="toggleSettings()">Done</button></div>${showPairSuggestion?`<div class="info-banner"><svg style="width:18px;height:18px;color:#2d6a4f;flex-shrink:0;margin-top:2px"fill="none"stroke="currentColor"viewBox="0 0 24 24"><circle cx="12"cy="12"r="10"stroke-width="2"/><line x1="12"y1="16"x2="12"y2="12"stroke-width="2"/><line x1="12"y1="8"x2="12.01"y2="8"stroke-width="2"/></svg><div class="info-content"><p class="info-title">Multi-platform station detected!</p><p class="info-text">${allStations[showPairSuggestion]} has another platform. Add it for complete train predictions?</p><div class="info-buttons"><button class="btn-info"onclick="addStationPair('${showPairSuggestion}')">Add ${allStations[showPairSuggestion]}</button><button class="btn-info-secondary"onclick="clearPairSuggestion()">Skip</button></div></div></div>`:''}<div class="input-group"><label class="input-label">Search Station by Name</label><input type="text"class="input"id="stationInput"value="${stationInput}"placeholder="Type station name..."/></div>${stationInput?`<div><h3 class="input-label">Matching Stations</h3><div class="search-results">${f.map(({code,name})=>`<button class="search-item"onclick="addStation('${code}')"${stations.includes(code)?'disabled':''}><div class="search-item-name">${name}</div><div class="search-item-code">Code: ${code}</div></button>`).join('')}</div></div>`:''}${stations.length>0?`<div><h3 class="input-label">Your Stations (${stations.length})</h3>${stations.map(c=>`<div class="station-list-item"><div class="station-list-name">${allStations[c]}</div><button class="btn-remove"onclick="removeStation('${c}')">Remove</button></div>`).join('')}</div>`:!stationInput?'<div class="empty-settings"><p style="font-size:0.875rem">No stations added yet</p><p style="font-size:0.75rem;margin-top:0.25rem">Start typing to search for stations</p></div>':''}</div></div></div>`
    }

    function renderMain(){
      return`<div class="app"><div class="container"><div class="header"><div class="header-left"><svg style="width:28px;height:28px;color:#2d6a4f"fill="none"stroke="currentColor"viewBox="0 0 24 24"><rect x="4"y="4"width="16"height="16"rx="2"stroke-width="2"/><path d="M4 11h16"stroke-width="2"/><path d="M12 4v7"stroke-width="2"/></svg><h1 class="header-title">Metro Tracker</h1></div><div class="header-buttons"><button class="icon-btn"onclick="fetchPredictions()"${loading?'disabled':''}><svg class="${loading?'spin':''}"style="width:20px;height:20px"fill="none"stroke="currentColor"viewBox="0 0 24 24"><path d="M21 2v6h-6"stroke-width="2"stroke-linecap="round"stroke-linejoin="round"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"stroke-width="2"stroke-linecap="round"stroke-linejoin="round"/><path d="M3 22v-6h6"stroke-width="2"stroke-linecap="round"stroke-linejoin="round"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"stroke-width="2"stroke-linecap="round"stroke-linejoin="round"/></svg></button><button class="icon-btn"onclick="toggleSettings()"><svg style="width:20px;height:20px"fill="none"stroke="currentColor"viewBox="0 0 24 24"><circle cx="12"cy="12"r="3"stroke-width="2"/><path d="M12 1v6m0 6v6"stroke-width="2"/></svg></button></div></div>${lastUpdate?`<div class="last-update"><svg style="width:14px;height:14px"fill="none"stroke="currentColor"viewBox="0 0 24 24"><circle cx="12"cy="12"r="10"stroke-width="2"/><polyline points="12 6 12 12 16 14"stroke-width="2"/></svg>Updated ${lastUpdate.toLocaleTimeString()}</div>`:''}${error?`<div class="alert"><svg style="width:18px;height:18px;color:#b91c1c;flex-shrink:0;margin-top:2px"fill="none"stroke="currentColor"viewBox="0 0 24 24"><circle cx="12"cy="12"r="10"stroke-width="2"/><line x1="12"y1="8"x2="12"y2="12"stroke-width="2"/><line x1="12"y1="16"x2="12.01"y2="16"stroke-width="2"/></svg><div><p class="alert-title">Error</p><p class="alert-text">${error}</p></div></div>`:''}${!stations.length?'<div class="empty-state"><svg class="empty-icon"fill="none"stroke="currentColor"viewBox="0 0 24 24"><circle cx="12"cy="12"r="3"/><path d="M12 1v6m0 6v6"/></svg><p style="color:#2c2c2c;font-size:1.05rem;font-weight:600;margin-bottom:0.4rem">No stations configured</p><p style="color:#8a8477;margin-bottom:1rem;font-size:0.9rem">Add your favorite stations to get started</p><button class="btn-primary"onclick="toggleSettings()">Add Stations</button></div>':stations.map(c=>renderStationCard(c)).join('')}</div></div>`
    }

    function attachEventListeners(){const i=document.getElementById('stationInput');if(i)i.addEventListener('input',e=>{stationInput=e.target.value;render()})}
    function toggleSettings(){showSettings=!showSettings;showPairSuggestion=null;stationInput='';render()}
    function clearPairSuggestion(){showPairSuggestion=null;render()}

    window.toggleSettings=toggleSettings;window.fetchPredictions=fetchPredictions;window.addStation=addStation;window.addStationPair=addStationPair;window.removeStation=removeStation;window.clearPairSuggestion=clearPairSuggestion;window.toggleLineFilter=toggleLineFilter;init()
  </script>
</body>
</html>
