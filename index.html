<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Metro">
  <title>DC Metro Tracker</title>
  
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiBmaWxsPSIjMDA1Njk1Ii8+CjxyZWN0IHg9IjMwIiB5PSI1MCIgd2lkdGg9IjMwIiBoZWlnaHQ9IjgwIiBmaWxsPSJ3aGl0ZSIvPgo8cmVjdCB4PSI3NSIgeT0iNTAiIHdpZHRoPSIzMCIgaGVpZ2h0PSI4MCIgZmlsbD0id2hpdGUiLz4KPHJlY3QgeD0iMTIwIiB5PSI1MCIgd2lkdGg9IjMwIiBoZWlnaHQ9IjgwIiBmaWxsPSJ3aGl0ZSIvPgo8cmVjdCB4PSIzMCIgeT0iNTAiIHdpZHRoPSIxMjAiIGhlaWdodD0iMjAiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; -webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; overscroll-behavior-y: contain; }
    .app { min-height: 100vh; background: linear-gradient(to bottom right, #1e3a8a, #1e40af, #3730a3); padding: 1rem; padding-bottom: 5rem; }
    .container { max-width: 48rem; margin: 0 auto; }
    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
    .header-left { display: flex; align-items: center; gap: 0.75rem; }
    .header-title { font-size: 1.5rem; font-weight: bold; color: white; }
    .header-buttons { display: flex; gap: 0.5rem; }
    .icon-btn { padding: 0.5rem; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(12px); border: none; border-radius: 0.5rem; color: white; cursor: pointer; transition: background 0.2s; }
    .icon-btn:hover:not(:disabled) { background: rgba(255, 255, 255, 0.3); }
    .icon-btn:disabled { opacity: 0.5; }
    .last-update { color: rgba(255, 255, 255, 0.7); font-size: 0.875rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; }
    .card-white { background: white; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); padding: 1.5rem; }
    .station-name { font-size: 1.125rem; font-weight: bold; color: white; margin-bottom: 0.25rem; }
    .train-item { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border-radius: 0.5rem; padding: 0.75rem; display: flex; align-items: center; justify-between; margin-top: 0.5rem; }
    .train-left { display: flex; align-items: center; gap: 0.75rem; flex: 1; }
    .line-dot { width: 0.5rem; height: 0.5rem; border-radius: 9999px; }
    .train-info { flex: 1; }
    .train-dest { color: white; font-weight: 500; }
    .train-cars { color: rgba(255, 255, 255, 0.6); font-size: 0.75rem; }
    .train-time { color: white; font-weight: bold; font-size: 1.125rem; text-align: right; }
    .empty-state { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border-radius: 0.75rem; padding: 2rem; text-align: center; }
    .empty-icon { width: 3rem; height: 3rem; color: rgba(255, 255, 255, 0.5); margin: 0 auto 1rem; }
    .btn-primary { padding: 0.5rem 1.5rem; background: white; color: #1e3a8a; border: none; border-radius: 0.5rem; font-weight: 500; cursor: pointer; }
    .btn-primary:hover { background: rgba(255, 255, 255, 0.9); }
    .settings-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
    .settings-title { font-size: 1.25rem; font-weight: bold; color: #1f2937; }
    .btn-link { color: #2563eb; font-weight: 500; background: none; border: none; cursor: pointer; padding: 0; }
    .btn-link:hover { color: #1d4ed8; }
    .input-group { margin-bottom: 1.5rem; }
    .input-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem; }
    .input { width: 100%; padding: 0.5rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; }
    .input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .search-results { max-height: 16rem; overflow-y: auto; margin-bottom: 1.5rem; }
    .search-item { width: 100%; padding: 0.75rem 1rem; text-align: left; border: 1px solid #d1d5db; border-radius: 0.5rem; background: white; cursor: pointer; margin-bottom: 0.5rem; transition: background 0.2s; }
    .search-item:hover:not(:disabled) { background: #eff6ff; }
    .search-item:disabled { background: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
    .search-item-name { font-weight: 500; color: #111827; }
    .search-item-code { font-size: 0.75rem; color: #6b7280; margin-top: 0.125rem; }
    .station-list-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border-radius: 0.5rem; margin-bottom: 0.5rem; }
    .station-list-name { font-weight: 500; color: #1f2937; }
    .btn-remove { color: #dc2626; font-size: 0.875rem; font-weight: 500; background: none; border: none; cursor: pointer; padding: 0; }
    .btn-remove:hover { color: #b91c1c; }
    .alert { background: rgba(239, 68, 68, 0.2); backdrop-filter: blur(12px); border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; display: flex; gap: 0.75rem; }
    .alert-title { color: #fecaca; font-weight: 500; }
    .alert-text { color: #fca5a5; font-size: 0.875rem; }
    .info-banner { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1.5rem; display: flex; gap: 0.75rem; }
    .info-content { flex: 1; }
    .info-title { font-size: 0.875rem; font-weight: 500; color: #1e3a8a; }
    .info-text { font-size: 0.875rem; color: #1e40af; margin-top: 0.25rem; }
    .info-buttons { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
    .btn-info { padding: 0.5rem 1rem; background: #2563eb; color: white; border: none; border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; }
    .btn-info-secondary { padding: 0.5rem 1rem; background: white; color: #374151; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; cursor: pointer; }
    .empty-text { color: rgba(255, 255, 255, 0.6); text-align: center; padding: 1rem 0; }
    .empty-settings { text-align: center; padding: 2rem 0; color: #6b7280; }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    const API_KEY = 'a904e787966948e39042f5055a178856';
    const allStations = {'A01':'Metro Center','A02':'Farragut North','A03':'Dupont Circle','A04':'Woodley Park-Zoo/Adams Morgan','A05':'Cleveland Park','A06':'Van Ness-UDC','A07':'Tenleytown-AU','A08':'Friendship Heights','A09':'Bethesda','A10':'Medical Center','A11':'Grosvenor-Strathmore','A12':'North Bethesda','A13':'Twinbrook','A14':'Rockville','A15':'Shady Grove','B01':'Gallery Pl-Chinatown','B02':'Judiciary Square','B03':'Union Station','B04':'Rhode Island Ave-Brentwood','B05':'Brookland-CUA','B06':'Fort Totten','B07':'Takoma','B08':'Silver Spring','B09':'Forest Glen','B10':'Wheaton','B11':'Glenmont','B35':'NoMa-Gallaudet U','C01':'Metro Center','C02':'McPherson Square','C03':'Farragut West','C04':'Foggy Bottom-GWU','C05':'Rosslyn','C06':'Arlington Cemetery','C07':'Pentagon','C08':'Pentagon City','C09':'Crystal City','C10':'Ronald Reagan Washington National Airport','C11':'Potomac Yard','C12':'Braddock Road','C13':'King St-Old Town','C14':'Eisenhower Avenue','C15':'Huntington','D01':'Federal Triangle','D02':'Smithsonian','D03':"L'Enfant Plaza",'D04':'Federal Center SW','D05':'Capitol South','D06':'Eastern Market','D07':'Potomac Ave','D08':'Stadium-Armory','D09':'Minnesota Ave','D10':'Deanwood','D11':'Cheverly','D12':'Landover','D13':'New Carrollton','E01':'Mt Vernon Sq 7th St-Convention Center','E02':'Shaw-Howard U','E03':'U Street/African-Amer Civil War Memorial/Cardozo','E04':'Columbia Heights','E05':'Georgia Ave-Petworth','E06':'Fort Totten','E07':'West Hyattsville','E08':'Hyattsville Crossing','E09':'College Park-U of Md','E10':'Greenbelt','F01':'Gallery Pl-Chinatown','F02':'Archives-Navy Memorial-Penn Quarter','F03':"L'Enfant Plaza",'F04':'Waterfront','F05':'Navy Yard-Ballpark','F06':'Anacostia','F07':'Congress Heights','F08':'Southern Avenue','F09':'Naylor Road','F10':'Suitland','F11':'Branch Ave','G01':'Benning Road','G02':'Capitol Heights','G03':'Addison Road-Seat Pleasant','G04':'Morgan Boulevard','G05':'Downtown Largo','J02':'Van Dorn Street','J03':'Franconia-Springfield','K01':'Court House','K02':'Clarendon','K03':'Virginia Square-GMU','K04':'Ballston-MU','K05':'East Falls Church','K06':'West Falls Church','K07':'Dunn Loring-Merrifield','K08':'Vienna/Fairfax-GMU','N01':'McLean','N02':'Tysons','N03':'Greensboro','N04':'Spring Hill','N06':'Wiehle-Reston East','N07':'Reston Town Center','N08':'Herndon','N09':'Innovation Center','N10':'Washington Dulles International Airport','N11':'Loudoun Gateway','N12':'Ashburn'};
    const pairedStations = {'A01':'C01','C01':'A01','B01':'F01','F01':'B01','B06':'E06','E06':'B06','D03':'F03','F03':'D03'};
    let stations=[],predictions={},loading=false,error='',showSettings=false,stationInput='',lastUpdate=null,showPairSuggestion=null,refreshInterval=null;
    function init(){const s=localStorage.getItem('metroTrackerStations');if(s){try{stations=JSON.parse(s)}catch(e){}}render();if(stations.length>0){fetchPredictions();refreshInterval=setInterval(fetchPredictions,30000)}}
    function saveStations(){stations.length>0?localStorage.setItem('metroTrackerStations',JSON.stringify(stations)):localStorage.removeItem('metroTrackerStations')}
    async function fetchPredictions(){if(!stations.length)return;loading=true;error='';predictions={};render();try{for(const c of stations){const r=await fetch(`https://api.wmata.com/StationPrediction.svc/json/GetPrediction/${c}`,{headers:{'api_key':API_KEY}});if(!r.ok)throw new Error(`Failed to fetch data for ${c}`);const d=await r.json();predictions[c]=d.Trains||[]}lastUpdate=new Date()}catch(e){error=e.message}finally{loading=false;render()}}
    function addStation(c){const u=c.trim().toUpperCase();if(u&&allStations[u]&&!stations.includes(u)){stations.push(u);saveStations();stationInput='';if(pairedStations[u]){const p=pairedStations[u];if(!stations.includes(p))showPairSuggestion=p}render();if(refreshInterval)clearInterval(refreshInterval);fetchPredictions();refreshInterval=setInterval(fetchPredictions,30000)}}
    function addStationPair(p){if(!stations.includes(p)){stations.push(p);saveStations()}showPairSuggestion=null;render();if(refreshInterval)clearInterval(refreshInterval);fetchPredictions();refreshInterval=setInterval(fetchPredictions,30000)}
    function removeStation(c){stations=stations.filter(s=>s!==c);saveStations();delete predictions[c];render();if(!stations.length&&refreshInterval){clearInterval(refreshInterval);refreshInterval=null}}
    function getLineColor(l){const c={'RD':'#ef4444','BL':'#3b82f6','YL':'#eab308','OR':'#f97316','GR':'#22c55e','SV':'#9ca3af'};return c[l]||'#6b7280'}
    function formatTime(m){return m==='ARR'||m==='BRD'?m:`${m} min`}
    function groupTrainsByDirection(trains){const groups={};trains.forEach(t=>{const dir=t.Group||'1';if(!groups[dir])groups[dir]=[];groups[dir].push(t)});return groups}
    function getDirectionLabel(trains){const dests=trains.map(t=>t.DestinationName||t.Destination).filter((v,i,a)=>a.indexOf(v)===i);return dests.length===1?dests[0]:dests.slice(0,2).join(', ')+(dests.length>2?' & more':'')}
    function getStationsByName(){return Object.entries(allStations).map(([c,n])=>({code:c,name:n})).sort((a,b)=>a.name.localeCompare(b.name))}
    function render(){document.getElementById('app').innerHTML=showSettings?renderSettings():renderMain();attachEventListeners()}
    function renderSettings(){const sb=getStationsByName();const f=stationInput?sb.filter(({name,code})=>name.toLowerCase().includes(stationInput.toLowerCase())||code.toLowerCase().includes(stationInput.toLowerCase())).slice(0,10):[];return`<div class="app"><div class="container"><div class="card-white"><div class="settings-header"><h2 class="settings-title">Station Settings</h2><button class="btn-link"onclick="toggleSettings()">Done</button></div>${showPairSuggestion?`<div class="info-banner"><svg style="width:20px;height:20px;color:#2563eb;flex-shrink:0;margin-top:2px"fill="none"stroke="currentColor"viewBox="0 0 24 24"><circle cx="12"cy="12"r="10"stroke-width="2"/><line x1="12"y1="16"x2="12"y2="12"stroke-width="2"/><line x1="12"y1="8"x2="12.01"y2="8"stroke-width="2"/></svg><div class="info-content"><p class="info-title">Multi-platform station detected!</p><p class="info-text">${allStations[showPairSuggestion]} has another platform. Add it for complete train predictions?</p><div class="info-buttons"><button class="btn-info"onclick="addStationPair('${showPairSuggestion}')">Add ${allStations[showPairSuggestion]}</button><button class="btn-info-secondary"onclick="clearPairSuggestion()">Skip</button></div></div></div>`:''}<div class="input-group"><label class="input-label">Search Station by Name</label><input type="text"class="input"id="stationInput"value="${stationInput}"placeholder="Type station name..."/></div>${stationInput?`<div><h3 class="input-label">Matching Stations</h3><div class="search-results">${f.map(({code,name})=>`<button class="search-item"onclick="addStation('${code}')"${stations.includes(code)?'disabled':''}><div class="search-item-name">${name}</div><div class="search-item-code">Code: ${code}</div></button>`).join('')}</div></div>`:''}${stations.length>0?`<div><h3 class="input-label">Your Stations (${stations.length})</h3>${stations.map(c=>`<div class="station-list-item"><div class="station-list-name">${allStations[c]}</div><button class="btn-remove"onclick="removeStation('${c}')">Remove</button></div>`).join('')}</div>`:!stationInput?'<div class="empty-settings"><p style="font-size:0.875rem">No stations added yet</p><p style="font-size:0.75rem;margin-top:0.25rem">Start typing to search for stations</p></div>':''}</div></div></div>`}
    function renderMain(){return`<div class="app"><div class="container"><div class="header"><div class="header-left"><svg style="width:32px;height:32px;color:white"fill="none"stroke="currentColor"viewBox="0 0 24 24"><rect x="4"y="4"width="16"height="16"rx="2"stroke-width="2"/><path d="M4 11h16"stroke-width="2"/><path d="M12 4v7"stroke-width="2"/></svg><h1 class="header-title">Metro Tracker</h1></div><div class="header-buttons"><button class="icon-btn"onclick="fetchPredictions()"${loading?'disabled':''}><svg class="${loading?'spin':''}"style="width:20px;height:20px"fill="none"stroke="currentColor"viewBox="0 0 24 24"><path d="M21 2v6h-6"stroke-width="2"stroke-linecap="round"stroke-linejoin="round"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"stroke-width="2"stroke-linecap="round"stroke-linejoin="round"/><path d="M3 22v-6h6"stroke-width="2"stroke-linecap="round"stroke-linejoin="round"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"stroke-width="2"stroke-linecap="round"stroke-linejoin="round"/></svg></button><button class="icon-btn"onclick="toggleSettings()"><svg style="width:20px;height:20px"fill="none"stroke="currentColor"viewBox="0 0 24 24"><circle cx="12"cy="12"r="3"stroke-width="2"/><path d="M12 1v6m0 6v6"stroke-width="2"/></svg></button></div></div>${lastUpdate?`<div class="last-update"><svg style="width:16px;height:16px"fill="none"stroke="currentColor"viewBox="0 0 24 24"><circle cx="12"cy="12"r="10"stroke-width="2"/><polyline points="12 6 12 12 16 14"stroke-width="2"/></svg>Last updated: ${lastUpdate.toLocaleTimeString()}</div>`:''}${error?`<div class="alert"><svg style="width:20px;height:20px;color:#fca5a5;flex-shrink:0;margin-top:2px"fill="none"stroke="currentColor"viewBox="0 0 24 24"><circle cx="12"cy="12"r="10"stroke-width="2"/><line x1="12"y1="8"x2="12"y2="12"stroke-width="2"/><line x1="12"y1="16"x2="12.01"y2="16"stroke-width="2"/></svg><div><p class="alert-title">Error</p><p class="alert-text">${error}</p></div></div>`:''}${!stations.length?'<div class="empty-state"><svg class="empty-icon"fill="none"stroke="currentColor"viewBox="0 0 24 24"><circle cx="12"cy="12"r="3"/><path d="M12 1v6m0 6v6"/></svg><p style="color:white;font-size:1.125rem;margin-bottom:0.5rem">No stations configured</p><p style="color:rgba(255,255,255,0.7);margin-bottom:1rem">Add your favorite stations to get started</p><button class="btn-primary"onclick="toggleSettings()">Add Stations</button></div>':stations.map(c=>`<div class="card"><h2 class="station-name">${allStations[c]}</h2>${predictions[c]&&predictions[c].length>0?(()=>{const groups=groupTrainsByDirection(predictions[c]);return Object.entries(groups).sort(([a],[b])=>a.localeCompare(b)).map(([dir,trains])=>`<div style="margin-top:1rem"><div style="color:rgba(255,255,255,0.85);font-size:0.875rem;font-weight:600;margin-bottom:0.5rem;display:flex;align-items:center;gap:0.5rem"><svg style="width:14px;height:14px"fill="none"stroke="currentColor"viewBox="0 0 24 24"><path d="M5 12h14m-7-7l7 7-7 7"stroke-width="2"stroke-linecap="round"stroke-linejoin="round"/></svg>To ${getDirectionLabel(trains)}</div>${trains.map(t=>`<div class="train-item"><div class="train-left"><div class="line-dot"style="background-color:${getLineColor(t.Line)}"></div><div class="train-info"><div class="train-dest">${t.Line} to ${t.DestinationName||t.Destination}</div>${t.Car?`<div class="train-cars">${t.Car} cars</div>`:''}</div></div><div class="train-time">${formatTime(t.Min)}</div></div>`).join('')}</div>`).join('')})():`<div class="empty-text">${loading?'Loading...':'No trains scheduled'}</div>`}</div>`).join('')}</div></div>`}
    function attachEventListeners(){const i=document.getElementById('stationInput');if(i)i.addEventListener('input',e=>{stationInput=e.target.value;render()})}
    function toggleSettings(){showSettings=!showSettings;showPairSuggestion=null;stationInput='';render()}
    function clearPairSuggestion(){showPairSuggestion=null;render()}
    window.toggleSettings=toggleSettings;window.fetchPredictions=fetchPredictions;window.addStation=addStation;window.addStationPair=addStationPair;window.removeStation=removeStation;window.clearPairSuggestion=clearPairSuggestion;init()
  </script>
</body>
</html>
