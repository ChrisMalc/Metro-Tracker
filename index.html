<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Metro Monitor">
  <title>Metro Monitor</title>
  
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9IiMyZDZhNGYiLz4KPHBvbHlnb24gcG9pbnRzPSI5MCwxNiAxNjQsOTAgOTAsMTY0IDE2LDkwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjUiIGZpbGw9Im5vbmUiIHN0cm9rZS1saW5lam9pbj0icm91bmQiLz4KPHRleHQgeD0iOTAiIHk9IjExMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9Ii1hcHBsZS1zeXN0ZW0sIEhlbHZldGljYSwgQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iODAiIGZvbnQtd2VpZ2h0PSI4MDAiIGZpbGw9IndoaXRlIj5NPC90ZXh0Pgo8L3N2Zz4K">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      overscroll-behavior-y: contain;
      background: #f4f1eb;
      color: #2c2c2c;
    }
    .app { min-height: 100vh; padding: 1rem; padding-top: 1.25rem; padding-bottom: 5rem; }
    .container { max-width: 48rem; margin: 0 auto; }

    .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; }
    .header-left { display: flex; align-items: center; gap: 0.6rem; }
    .header-title { font-size: 1.4rem; font-weight: 700; color: #2d6a4f; }
    .header-buttons { display: flex; gap: 0.5rem; }
    .icon-btn {
      padding: 0.5rem; background: #2d6a4f;
      border: none; border-radius: 0.6rem;
      color: white; cursor: pointer; transition: background 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .icon-btn:hover:not(:disabled) { background: #245a42; }
    .icon-btn:disabled { opacity: 0.45; }

    .last-update { color: #6b7264; font-size: 0.8rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.4rem; }

    .alerts-banner {
      background: #fef8ee; border: 1px solid #f5d9a8;
      border-radius: 0.7rem; padding: 0.7rem 0.85rem; margin-bottom: 0.85rem;
    }
    .alerts-header {
      display: flex; align-items: center; gap: 0.4rem;
      font-size: 0.78rem; font-weight: 700; color: #92400e;
      margin-bottom: 0.35rem; text-transform: uppercase; letter-spacing: 0.03em;
    }
    .alert-item {
      font-size: 0.82rem; color: #78350f; line-height: 1.4;
      padding: 0.35rem 0; border-top: 1px solid #f5e6cc;
    }
    .alert-item:first-child { border-top: none; padding-top: 0; }
    .alert-lines { font-weight: 600; color: #92400e; }

    .card {
      background: #ffffff; border: 1px solid #ddd8cf;
      border-radius: 0.85rem; padding: 1rem; margin-bottom: 0.85rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .station-header {
      display: flex; align-items: center; justify-content: space-between;
      cursor: pointer; -webkit-user-select: none; user-select: none;
    }
    .station-name { font-size: 1.05rem; font-weight: 700; color: #2d6a4f; display: flex; align-items: center; }
    .collapse-arrow {
      font-size: 1.1rem; color: #6b7264; transition: transform 0.2s ease;
      padding: 0.2rem 0.3rem;
    }
    .collapse-arrow.collapsed { transform: rotate(-90deg); }
    .station-body { margin-top: 0.4rem; }
    .station-body.hidden { display: none; }

    .line-filters { display: flex; flex-wrap: wrap; gap: 0.3rem; margin: 0.35rem 0 0.5rem 0; }
    .line-filter-btn {
      padding: 0.22rem 0.6rem; font-size: 0.7rem; font-weight: 600;
      border: 1.5px solid #d1cdc4; border-radius: 999px;
      background: #fafaf7; color: #6b7264; cursor: pointer;
      transition: all 0.15s ease; line-height: 1.3;
    }
    .line-filter-btn:hover { border-color: #a09a8e; }

    .direction-group { margin-bottom: 0.6rem; }
    .direction-group:last-child { margin-bottom: 0; }
    .direction-label {
      font-size: 0.68rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;
      color: #8a8477; padding: 0.2rem 0.1rem; margin-bottom: 0.25rem;
      display: flex; align-items: center; gap: 0.35rem;
    }
    .direction-arrow { font-size: 0.6rem; color: #a09a8e; }
    .direction-divider { height: 1px; background: #e8e4dc; margin: 0.55rem 0; }

    .train-item {
      background: #fafaf7; border: 1px solid #eae6de;
      border-radius: 0.55rem; padding: 0.65rem 0.75rem;
      display: flex; align-items: center; justify-content: space-between; margin-top: 0.3rem;
    }
    .train-left { display: flex; align-items: center; gap: 0.65rem; flex: 1; }
    .line-dot { width: 0.55rem; height: 0.55rem; border-radius: 9999px; flex-shrink: 0; }
    .train-info { flex: 1; }
    .train-dest { color: #2c2c2c; font-weight: 500; font-size: 0.92rem; }
    .train-cars { color: #8a8477; font-size: 0.72rem; margin-top: 0.1rem; }
    .train-time { color: #2d6a4f; font-weight: 700; font-size: 1.05rem; text-align: right; white-space: nowrap; padding-left: 0.75rem; }
    .train-time-arriving { color: #b45309; }

    .empty-state {
      background: #ffffff; border: 1px solid #ddd8cf;
      border-radius: 0.85rem; padding: 2.5rem 1.5rem; text-align: center;
    }
    .empty-icon { width: 2.5rem; height: 2.5rem; color: #a09a8e; margin: 0 auto 0.75rem; }
    .empty-text { color: #8a8477; text-align: center; padding: 0.75rem 0; font-size: 0.88rem; }

    .btn-primary {
      padding: 0.55rem 1.5rem; background: #2d6a4f; color: white;
      border: none; border-radius: 0.55rem; font-weight: 600; font-size: 0.92rem; cursor: pointer;
    }
    .btn-primary:hover { background: #245a42; }

    .card-white {
      background: white; border: 1px solid #ddd8cf;
      border-radius: 0.85rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 1.5rem;
    }
    .settings-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; }
    .settings-title { font-size: 1.15rem; font-weight: 700; color: #2c2c2c; }
    .btn-link { color: #2d6a4f; font-weight: 600; background: none; border: none; cursor: pointer; padding: 0; font-size: 0.95rem; }
    .btn-link:hover { color: #245a42; }

    .input-group { margin-bottom: 1.25rem; }
    .input-label { display: block; font-size: 0.82rem; font-weight: 600; color: #5a5a5a; margin-bottom: 0.4rem; }
    .input {
      width: 100%; padding: 0.55rem 0.85rem;
      border: 1px solid #d1cdc4; border-radius: 0.5rem;
      font-size: 1rem; background: #fafaf7; color: #2c2c2c;
    }
    .input:focus { outline: none; border-color: #2d6a4f; box-shadow: 0 0 0 3px rgba(45, 106, 79, 0.12); }

    .search-results { max-height: 16rem; overflow-y: auto; margin-bottom: 1.25rem; }
    .search-item {
      width: 100%; padding: 0.7rem 0.85rem; text-align: left;
      border: 1px solid #e0dcd4; border-radius: 0.5rem;
      background: #fafaf7; cursor: pointer; margin-bottom: 0.4rem; transition: background 0.15s;
    }
    .search-item:hover:not(:disabled) { background: #eef5ec; border-color: #b5ccba; }
    .search-item:disabled { background: #f0ede8; color: #aaa69e; cursor: not-allowed; }
    .search-item-name { font-weight: 500; color: #2c2c2c; }
    .search-item-code { font-size: 0.72rem; color: #8a8477; margin-top: 0.1rem; }

    .station-list-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.7rem 0.75rem; background: #fafaf7;
      border: 1px solid #e8e4dc; border-radius: 0.5rem; margin-bottom: 0.4rem;
    }
    .station-list-name { font-weight: 500; color: #2c2c2c; }
    .btn-remove { color: #c0392b; font-size: 0.82rem; font-weight: 600; background: none; border: none; cursor: pointer; padding: 0; }
    .btn-remove:hover { color: #a5311f; }

    .alert { background: #fef2f2; border: 1px solid #f5c6c6; border-radius: 0.6rem; padding: 0.85rem; margin-bottom: 0.85rem; display: flex; gap: 0.6rem; }
    .alert-title { color: #991b1b; font-weight: 600; font-size: 0.88rem; }
    .alert-text { color: #b91c1c; font-size: 0.82rem; }

    .info-banner {
      background: #eef5ec; border: 1px solid #b5ccba;
      border-radius: 0.6rem; padding: 0.85rem; margin-bottom: 1.25rem; display: flex; gap: 0.6rem;
    }
    .info-content { flex: 1; }
    .info-title { font-size: 0.85rem; font-weight: 600; color: #2d6a4f; }
    .info-text { font-size: 0.82rem; color: #3a7d5c; margin-top: 0.2rem; }
    .info-buttons { display: flex; gap: 0.5rem; margin-top: 0.65rem; }
    .btn-info { padding: 0.45rem 0.85rem; background: #2d6a4f; color: white; border: none; border-radius: 0.45rem; font-size: 0.82rem; font-weight: 500; cursor: pointer; }
    .btn-info:hover { background: #245a42; }
    .btn-info-secondary { padding: 0.45rem 0.85rem; background: white; color: #5a5a5a; border: 1px solid #d1cdc4; border-radius: 0.45rem; font-size: 0.82rem; cursor: pointer; }
    .btn-info-secondary:hover { background: #f4f1eb; }

    .empty-settings { text-align: center; padding: 2rem 0; color: #8a8477; }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    const API_KEY = 'a904e787966948e39042f5055a178856';
    const allStations = {'A01':'Metro Center','A02':'Farragut North','A03':'Dupont Circle','A04':'Woodley Park-Zoo/Adams Morgan','A05':'Cleveland Park','A06':'Van Ness-UDC','A07':'Tenleytown-AU','A08':'Friendship Heights','A09':'Bethesda','A10':'Medical Center','A11':'Grosvenor-Strathmore','A12':'North Bethesda','A13':'Twinbrook','A14':'Rockville','A15':'Shady Grove','B01':'Gallery Pl-Chinatown','B02':'Judiciary Square','B03':'Union Station','B04':'Rhode Island Ave-Brentwood','B05':'Brookland-CUA','B06':'Fort Totten','B07':'Takoma','B08':'Silver Spring','B09':'Forest Glen','B10':'Wheaton','B11':'Glenmont','B35':'NoMa-Gallaudet U','C01':'Metro Center','C02':'McPherson Square','C03':'Farragut West','C04':'Foggy Bottom-GWU','C05':'Rosslyn','C06':'Arlington Cemetery','C07':'Pentagon','C08':'Pentagon City','C09':'Crystal City','C10':'Ronald Reagan Washington National Airport','C11':'Potomac Yard','C12':'Braddock Road','C13':'King St-Old Town','C14':'Eisenhower Avenue','C15':'Huntington','D01':'Federal Triangle','D02':'Smithsonian','D03':"L'Enfant Plaza",'D04':'Federal Center SW','D05':'Capitol South','D06':'Eastern Market','D07':'Potomac Ave','D08':'Stadium-Armory','D09':'Minnesota Ave','D10':'Deanwood','D11':'Cheverly','D12':'Landover','D13':'New Carrollton','E01':'Mt Vernon Sq 7th St-Convention Center','E02':'Shaw-Howard U','E03':'U Street/African-Amer Civil War Memorial/Cardozo','E04':'Columbia Heights','E05':'Georgia Ave-Petworth','E06':'Fort Totten','E07':'West Hyattsville','E08':'Hyattsville Crossing','E09':'College Park-U of Md','E10':'Greenbelt','F01':'Gallery Pl-Chinatown','F02':'Archives-Navy Memorial-Penn Quarter','F03':"L'Enfant Plaza",'F04':'Waterfront','F05':'Navy Yard-Ballpark','F06':'Anacostia','F07':'Congress Heights','F08':'Southern Avenue','F09':'Naylor Road','F10':'Suitland','F11':'Branch Ave','G01':'Benning Road','G02':'Capitol Heights','G03':'Addison Road-Seat Pleasant','G04':'Morgan Boulevard','G05':'Downtown Largo','J02':'Van Dorn Street','J03':'Franconia-Springfield','K01':'Court House','K02':'Clarendon','K03':'Virginia Square-GMU','K04':'Ballston-MU','K05':'East Falls Church','K06':'West Falls Church','K07':'Dunn Loring-Merrifield','K08':'Vienna/Fairfax-GMU','N01':'McLean','N02':'Tysons','N03':'Greensboro','N04':'Spring Hill','N06':'Wiehle-Reston East','N07':'Reston Town Center','N08':'Herndon','N09':'Innovation Center','N10':'Washington Dulles International Airport','N11':'Loudoun Gateway','N12':'Ashburn'};
    const pairedStations = {'A01':'C01','C01':'A01','B01':'F01','F01':'B01','B06':'E06','E06':'B06','D03':'F03','F03':'D03'};

    // Static fallback: lines by station code prefix
    const prefixLines = {
      'A':'RD','B':'RD','C':'BL,OR,SV','D':'BL,OR,SV,YL','E':'GR,YL','F':'GR,YL',
      'G':'BL,SV','J':'BL,YL','K':'OR,SV','N':'SV'
    };

    let stations=[], predictions={}, loading=false, error='', showSettings=false, stationInput='', lastUpdate=null, refreshInterval=null;
    let collapsedStations = new Set();  // keyed by groupKey
    let lineSelections = {};            // groupKey -> Set of selected lines
    let railAlerts = [];

    // ===== Display Groups: merge paired stations into single cards =====
    function getDisplayGroups(){
      const groups=[], used=new Set();
      for(const c of stations){
        if(used.has(c)) continue;
        used.add(c);
        const pair=pairedStations[c];
        if(pair && stations.includes(pair)){
          used.add(pair);
          groups.push({codes:[c,pair], name:allStations[c]});
        } else {
          groups.push({codes:[c], name:allStations[c]});
        }
      }
      return groups;
    }

    function getGroupKey(codes){ return codes.slice().sort().join('+'); }

    // Get all trains across all codes in a display group
    function getGroupTrains(codes){
      let all=[];
      for(const c of codes){
        const trains=predictions[c]||[];
        // Tag each train with its source location for unique direction grouping
        for(const t of trains) all.push({...t, _src:c});
      }
      return all;
    }

    // Get all unique lines for a display group (from live data + fallback)
    function getGroupLines(codes){
      const lines=new Set();
      // From live predictions
      for(const c of codes){
        for(const t of (predictions[c]||[])){
          if(t.Line && t.Line.length===2 && !isSpecialTrain(t)) lines.add(t.Line);
        }
      }
      // Fallback if no predictions yet
      if(lines.size===0){
        for(const c of codes){
          const pf=prefixLines[c.charAt(0)];
          if(pf) pf.split(',').forEach(l=>lines.add(l));
        }
      }
      return lines;
    }

    // Ensure line selections exist for a group, defaulting all to selected
    function ensureLineSelections(groupKey, availableLines){
      if(!lineSelections[groupKey]){
        lineSelections[groupKey] = new Set(availableLines);
      } else {
        // Add any new lines as selected
        for(const l of availableLines){
          if(!lineSelections[groupKey].has(l)){
            // Only auto-add if this is a genuinely new line
            lineSelections[groupKey].add(l);
          }
        }
      }
    }

    function toggleLineSelection(groupKey, line){
      if(!lineSelections[groupKey]) return;
      const sel=lineSelections[groupKey];
      if(sel.has(line)) sel.delete(line);
      else sel.add(line);
      saveLineSelections();
      render();
    }

    // ===== Init =====
    function init(){
      const s=localStorage.getItem('metroTrackerStations');
      if(s){try{stations=JSON.parse(s)}catch(e){}}
      const c=localStorage.getItem('metroCollapsed');
      if(c){try{collapsedStations=new Set(JSON.parse(c))}catch(e){}}
      const ls=localStorage.getItem('metroLineSelections');
      if(ls){try{
        const obj=JSON.parse(ls);
        for(const k in obj) lineSelections[k]=new Set(obj[k]);
      }catch(e){}}
      render();
      if(stations.length>0){fetchAll(); refreshInterval=setInterval(fetchAll,30000)}
    }

    function saveStations(){
      stations.length>0?localStorage.setItem('metroTrackerStations',JSON.stringify(stations)):localStorage.removeItem('metroTrackerStations')
    }
    function saveCollapsed(){
      collapsedStations.size>0?localStorage.setItem('metroCollapsed',JSON.stringify([...collapsedStations])):localStorage.removeItem('metroCollapsed')
    }
    function saveLineSelections(){
      const obj={};
      for(const k in lineSelections) obj[k]=[...lineSelections[k]];
      localStorage.setItem('metroLineSelections',JSON.stringify(obj));
    }

    // ===== Data fetching =====
    async function fetchAll(){ await Promise.all([fetchPredictions(), fetchAlerts()]); }

    async function fetchPredictions(){
      if(!stations.length) return;
      loading=true; error=''; predictions={}; render();
      try{
        for(const c of stations){
          const r=await fetch(`https://api.wmata.com/StationPrediction.svc/json/GetPrediction/${c}`,{headers:{'api_key':API_KEY}});
          if(!r.ok) throw new Error(`Failed to fetch for ${c}`);
          const d=await r.json();
          predictions[c]=d.Trains||[];
        }
        lastUpdate=new Date();
        // Ensure line selections are populated for all display groups
        for(const g of getDisplayGroups()){
          const gk=getGroupKey(g.codes);
          const lines=getGroupLines(g.codes);
          ensureLineSelections(gk, lines);
        }
        saveLineSelections();
      }catch(e){error=e.message}finally{loading=false;render()}
    }

    async function fetchAlerts(){
      try{
        const r=await fetch('https://api.wmata.com/Incidents.svc/json/Incidents',{headers:{'api_key':API_KEY}});
        if(!r.ok) return;
        const d=await r.json();
        railAlerts=(d.Incidents||[]).filter(a=>a.Description);
        render();
      }catch(e){/* silent */}
    }

    // ===== Station management =====
    function addStation(c){
      const u=c.trim().toUpperCase();
      if(!u||!allStations[u]||stations.includes(u)) return;
      stations.push(u);
      // Auto-add paired platform
      const pair=pairedStations[u];
      if(pair && !stations.includes(pair)){
        stations.push(pair);
      }
      saveStations(); stationInput='';
      // Initialize line selections for the new group
      const codes=pair&&stations.includes(pair)?[u,pair]:[u];
      const gk=getGroupKey(codes);
      const lines=getGroupLines(codes);
      ensureLineSelections(gk, lines);
      saveLineSelections();
      render();
      if(refreshInterval) clearInterval(refreshInterval);
      fetchAll(); refreshInterval=setInterval(fetchAll,30000);
    }

    function removeStation(c){
      // Also remove paired station
      const pair=pairedStations[c];
      stations=stations.filter(s=>s!==c&&s!==pair);
      saveStations();
      delete predictions[c];
      if(pair) delete predictions[pair];
      render();
      if(!stations.length&&refreshInterval){clearInterval(refreshInterval);refreshInterval=null}
    }

    function toggleCollapse(gk){
      if(collapsedStations.has(gk)) collapsedStations.delete(gk);
      else collapsedStations.add(gk);
      saveCollapsed(); render();
    }

    // ===== Line helpers =====
    function getLineColor(l){
      return {'RD':'#dc2626','BL':'#2563eb','YL':'#ca8a04','OR':'#ea580c','GR':'#16a34a','SV':'#71717a'}[l]||'#71717a';
    }
    function getLineName(l){
      return {'RD':'Red','BL':'Blue','YL':'Yellow','OR':'Orange','GR':'Green','SV':'Silver'}[l]||l;
    }
    function getLineFilterBg(l){
      return {'RD':'rgba(220,38,38,0.12)','BL':'rgba(37,99,235,0.12)','YL':'rgba(202,138,4,0.12)','OR':'rgba(234,88,12,0.12)','GR':'rgba(22,163,74,0.12)','SV':'rgba(113,113,122,0.12)'}[l]||'rgba(113,113,122,0.1)';
    }
    // Canonical line order for consistent pill display
    const lineOrder=['RD','OR','YL','GR','BL','SV'];
    function sortLines(linesSet){
      return lineOrder.filter(l=>linesSet.has(l));
    }

    // ===== Formatting =====
    function formatDestName(name){ return name.replace(/\//g,' & '); }
    function formatTime(m){ return m==='ARR'||m==='BRD'?m:`${m} min`; }
    function isArriving(m){ return m==='ARR'||m==='BRD'; }
    function getStationsByName(){
      return Object.entries(allStations).map(([c,n])=>({code:c,name:n})).sort((a,b)=>a.name.localeCompare(b.name));
    }

    // ===== Special trains =====
    const noServiceTrains=new Set(['train','no passenger','no psngrs']);
    const lastTrainLabels=new Set(['lasttrain','last train']);

    function isNoServiceTrain(t){
      const dest=(t.Destination||'').toLowerCase().trim();
      const destName=(t.DestinationName||'').toLowerCase().trim();
      return noServiceTrains.has(dest)||noServiceTrains.has(destName)||dest===''||(!t.Line||t.Line.length!==2);
    }
    function isLastTrain(t){
      const dest=(t.Destination||'').toLowerCase().trim();
      const destName=(t.DestinationName||'').toLowerCase().trim();
      return lastTrainLabels.has(dest)||lastTrainLabels.has(destName);
    }
    function isSpecialTrain(t){ return isNoServiceTrain(t)||isLastTrain(t); }

    function getFullDestination(t){
      let name;
      if(t.DestinationCode&&allStations[t.DestinationCode]) name=allStations[t.DestinationCode];
      else if(t.DestinationName&&t.DestinationName.length>2&&!lastTrainLabels.has(t.DestinationName.toLowerCase().trim())) name=t.DestinationName;
      else name=null;
      return name?formatDestName(name):null;
    }
    function getLastTrainDest(t){
      // Try to get real destination from DestinationCode even though Destination says "lasttrain"
      if(t.DestinationCode&&allStations[t.DestinationCode]) return formatDestName(allStations[t.DestinationCode]);
      return null;
    }

    // ===== Direction grouping =====
    // Use source station + Group to create unique direction keys across merged platforms
    function groupTrainsByDirection(trains){
      const groups={};
      for(const t of trains){
        const key=(t._src||t.LocationCode||'?')+'-'+(t.Group||'?');
        if(!groups[key]) groups[key]=[];
        groups[key].push(t);
      }
      return groups;
    }
    function getDirectionLabel(trains){
      const dests=[],seen=new Set();
      for(const t of trains){
        if(isNoServiceTrain(t)) continue;
        let name;
        if(isLastTrain(t)) name=getLastTrainDest(t);
        else name=getFullDestination(t);
        if(name&&!seen.has(name)){seen.add(name);dests.push(name)}
      }
      return dests.length?'Toward '+dests.join(', '):'Trains';
    }

    // ===== Alerts =====
    function parseAlertLines(a){ return (a.LinesAffected||'').split(/;[\s]?/).filter(l=>l.trim()).map(l=>l.trim()); }

    function getAllUserLines(){
      const lines=new Set();
      for(const g of getDisplayGroups()){
        for(const l of getGroupLines(g.codes)) lines.add(l);
      }
      return lines;
    }
    function getRelevantAlerts(){
      const userLines=getAllUserLines();
      return railAlerts.filter(a=>parseAlertLines(a).some(l=>userLines.has(l)));
    }
    function groupHasAlert(codes){
      const gLines=getGroupLines(codes);
      if(gLines.size===0) return false;
      return railAlerts.some(a=>parseAlertLines(a).some(l=>gLines.has(l)));
    }

    // ===== Rendering =====
    const alertIconSvg='<svg style="width:14px;height:14px;flex-shrink:0;margin-left:0.3rem" fill="none" stroke="#dc2626" viewBox="0 0 24 24" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke-linejoin="round"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';

    function renderAlertsBanner(){
      const relevant=getRelevantAlerts();
      if(!relevant.length) return '';
      let h=`<div class="alerts-banner"><div class="alerts-header"><svg style="width:14px;height:14px;flex-shrink:0" fill="none" stroke="#92400e" viewBox="0 0 24 24" stroke-width="2.5"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke-linejoin="round"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>Service Alerts</div>`;
      for(const a of relevant){
        const lines=parseAlertLines(a).map(l=>getLineName(l)).join(', ');
        h+=`<div class="alert-item">${lines?`<span class="alert-lines">${lines}:</span> `:''}${a.Description}</div>`;
      }
      return h+'</div>';
    }

    function renderTrainItem(t){
      const arriving=isArriving(t.Min);
      const lastTrain=isLastTrain(t);
      const noService=isNoServiceTrain(t);

      let destDisplay, dotColor, destStyle='';

      if(noService){
        destDisplay='Not In Service';
        dotColor='#a09a8e';
        destStyle='color:#8a8477;font-style:italic';
      } else if(lastTrain){
        const dest=getLastTrainDest(t);
        const lineName=t.Line?getLineName(t.Line):'';
        if(dest&&lineName){
          destDisplay=`${lineName} to ${dest} – <em style="font-weight:400">Last Train</em>`;
        } else if(lineName){
          destDisplay=`${lineName} – <em style="font-weight:400">Last Train</em>`;
        } else {
          destDisplay='<em>Last Train</em>';
        }
        dotColor=t.Line?getLineColor(t.Line):'#a09a8e';
      } else {
        destDisplay=getLineName(t.Line)+' to '+(getFullDestination(t)||'Unknown');
        dotColor=getLineColor(t.Line);
      }

      return`<div class="train-item"><div class="train-left"><div class="line-dot" style="background-color:${dotColor}"></div><div class="train-info"><div class="train-dest" style="${destStyle}">${destDisplay}</div>${t.Car&&!noService?`<div class="train-cars">${t.Car} cars</div>`:''}</div></div><div class="train-time${arriving?' train-time-arriving':''}">${formatTime(t.Min)}</div></div>`;
    }

    function renderDisplayGroup(group){
      const gk=getGroupKey(group.codes);
      const isCollapsed=collapsedStations.has(gk);
      const stName=formatDestName(group.name);
      const hasAlert=groupHasAlert(group.codes);
      const allTrains=getGroupTrains(group.codes);
      const availableLines=getGroupLines(group.codes);
      ensureLineSelections(gk, availableLines);
      const sel=lineSelections[gk]||new Set();
      const sortedLines=sortLines(availableLines);

      // Filter trains by selected lines
      const filteredTrains=allTrains.filter(t=>{
        if(isNoServiceTrain(t)) return true;  // always show no-service
        if(isLastTrain(t)) return t.Line?sel.has(t.Line):true;  // last trains filter by line
        return sel.has(t.Line);
      });

      // Build header
      let h=`<div class="card">`;
      h+=`<div class="station-header" onclick="toggleCollapse('${gk}')">`;
      h+=`<h2 class="station-name">${stName}${hasAlert?alertIconSvg:''}</h2>`;
      h+=`<span class="collapse-arrow${isCollapsed?' collapsed':''}">▾</span></div>`;

      // Body
      h+=`<div class="station-body${isCollapsed?' hidden':''}">`;

      // Line filter pills (always visible when expanded)
      if(sortedLines.length>0){
        h+=`<div class="line-filters">`;
        for(const line of sortedLines){
          const active=sel.has(line);
          const bg=active?getLineFilterBg(line):'transparent';
          const border=active?getLineColor(line):'#d1cdc4';
          const color=active?getLineColor(line):'#6b7264';
          h+=`<button class="line-filter-btn" onclick="event.stopPropagation();toggleLineSelection('${gk}','${line}')" style="background:${bg};border-color:${border};color:${color}">${getLineName(line)}</button>`;
        }
        h+=`</div>`;
      }

      if(!filteredTrains.length){
        h+=`<div class="empty-text">${loading?'Loading...':'No trains scheduled'}</div>`;
      } else {
        const grouped=groupTrainsByDirection(filteredTrains);
        const keys=Object.keys(grouped).sort();
        keys.forEach((k,i)=>{
          const dt=grouped[k];
          h+=`<div class="direction-group">`;
          h+=`<div class="direction-label"><span class="direction-arrow">▸</span> ${getDirectionLabel(dt)}</div>`;
          h+=dt.map(renderTrainItem).join('');
          h+=`</div>`;
          if(i<keys.length-1) h+=`<div class="direction-divider"></div>`;
        });
      }

      h+=`</div></div>`;
      return h;
    }

    // ===== Main render with focus preservation =====
    function render(){
      const activeEl=document.activeElement;
      const hadFocus=activeEl&&activeEl.id==='stationInput';
      const cursorPos=hadFocus?activeEl.selectionStart:0;

      document.getElementById('app').innerHTML=showSettings?renderSettings():renderMain();

      if(hadFocus){
        const inp=document.getElementById('stationInput');
        if(inp){ inp.focus(); inp.setSelectionRange(cursorPos,cursorPos); }
      }
      attachEventListeners();
    }

    function renderSettings(){
      const sb=getStationsByName();
      const f=stationInput?sb.filter(({name,code})=>name.toLowerCase().includes(stationInput.toLowerCase())||code.toLowerCase().includes(stationInput.toLowerCase())).slice(0,10):[];
      // For station list in settings, show merged display groups
      const dg=getDisplayGroups();
      return`<div class="app"><div class="container"><div class="card-white"><div class="settings-header"><h2 class="settings-title">Station Settings</h2><button class="btn-link" onclick="toggleSettings()">Done</button></div><div class="input-group"><label class="input-label">Search Station by Name</label><input type="text" class="input" id="stationInput" value="${stationInput}" placeholder="Type station name..."/></div>${stationInput?`<div><h3 class="input-label">Matching Stations</h3><div class="search-results">${f.map(({code,name})=>{
        // If this station or its pair is already added, disable
        const pair=pairedStations[code];
        const alreadyAdded=stations.includes(code)||(pair&&stations.includes(pair));
        return`<button class="search-item" onclick="addStation('${code}')"${alreadyAdded?' disabled':''}><div class="search-item-name">${name}</div><div class="search-item-code">Code: ${code}</div></button>`;
      }).join('')}</div></div>`:''}${dg.length>0?`<div><h3 class="input-label">Your Stations (${dg.length})</h3>${dg.map(g=>`<div class="station-list-item"><div class="station-list-name">${formatDestName(g.name)}</div><button class="btn-remove" onclick="removeStation('${g.codes[0]}')">Remove</button></div>`).join('')}</div>`:!stationInput?'<div class="empty-settings"><p style="font-size:0.875rem">No stations added yet</p><p style="font-size:0.75rem;margin-top:0.25rem">Start typing to search for stations</p></div>':''}</div></div></div>`;
    }

    function renderMain(){
      const dg=getDisplayGroups();
      return`<div class="app"><div class="container"><div class="header"><div class="header-left"><svg style="width:28px;height:28px" viewBox="0 0 24 24" fill="none" stroke="#2d6a4f" stroke-width="1.6" stroke-linejoin="round"><polygon points="12,1.5 22.5,12 12,22.5 1.5,12"/><text x="12" y="16.2" text-anchor="middle" font-family="-apple-system,Helvetica,sans-serif" font-size="12" font-weight="800" fill="#2d6a4f" stroke="none">M</text></svg><h1 class="header-title">Metro Monitor</h1></div><div class="header-buttons"><button class="icon-btn" onclick="manualRefresh()"${loading?' disabled':''}><svg class="${loading?'spin':''}" style="width:20px;height:20px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 2v6h-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 22v-6h6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button><button class="icon-btn" onclick="toggleSettings()" style="font-size:1.4rem;font-weight:300;line-height:1;padding:0.3rem 0.55rem">+</button></div></div>${lastUpdate?`<div class="last-update"><svg style="width:14px;height:14px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><polyline points="12 6 12 12 16 14" stroke-width="2"/></svg>Updated ${lastUpdate.toLocaleTimeString()}</div>`:''}${renderAlertsBanner()}${error?`<div class="alert"><svg style="width:18px;height:18px;color:#b91c1c;flex-shrink:0;margin-top:2px" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"/><line x1="12" y1="8" x2="12" y2="12" stroke-width="2"/><line x1="12" y1="16" x2="12.01" y2="16" stroke-width="2"/></svg><div><p class="alert-title">Error</p><p class="alert-text">${error}</p></div></div>`:''}${!dg.length?'<div class="empty-state"><svg class="empty-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6"/></svg><p style="color:#2c2c2c;font-size:1.05rem;font-weight:600;margin-bottom:0.4rem">No stations configured</p><p style="color:#8a8477;margin-bottom:1rem;font-size:0.9rem">Tap + to add your favorite stations</p><button class="btn-primary" onclick="toggleSettings()">Add Stations</button></div>':dg.map(g=>renderDisplayGroup(g)).join('')}</div></div>`;
    }

    function attachEventListeners(){
      const inp=document.getElementById('stationInput');
      if(inp) inp.addEventListener('input', e=>{ stationInput=e.target.value; render(); });
    }

    function manualRefresh(){ fetchAll(); }
    function toggleSettings(){ showSettings=!showSettings; stationInput=''; render(); }

    window.toggleSettings=toggleSettings;
    window.manualRefresh=manualRefresh;
    window.addStation=addStation;
    window.removeStation=removeStation;
    window.toggleCollapse=toggleCollapse;
    window.toggleLineSelection=toggleLineSelection;
    init();
  </script>
</body>
</html>
